# 蔚来汽车实习总结


## 商户商品查询总结


### 接口

```java

@RestController
@RequestMapping("/api/v1/carserve/commodity")
public class MerchantCommodity4CController {

    @Autowired
    private MerchantCommodity4CFacade merchantCommodity4CFacade;

    /**
     * 商品详情查询
     * @param
     * @return
     */
    @PostMapping("/detail")
    public BaseResponse<MerchantCommodityDetailDTO> queryDetail(@RequestBody MerchantCommodityDetail4CRequest request){
        return this.merchantCommodity4CFacade.queryDetail(request);
    }

}

```

* 这段代码是一个基于Spring框架的Java类，是一个RESTful风格的控制器（Controller）。以下是对代码的总结：

注解说明：

* @RestController: 表明这是一个控制器类，用于处理HTTP请求，并且返回的数据会直接写入HTTP响应体中。
* @RequestMapping("/api/v1/carserve/commodity"): 映射请求的基本URL路径，即所有该控制器下的接口路径都以 "/api/v1/carserve/commodity" 开头。
成员变量：

* private MerchantCommodity4CFacade merchantCommodity4CFacade;: 使用@Autowired注解进行自动装配，将MerchantCommodity4CFacade类型的Bean注入到该成员变量中。这可能是一个服务接口的外观（Facade）。
接口方法：

* @PostMapping("/detail"): 映射HTTP POST请求到 "/api/v1/carserve/commodity/detail" 路径。
public BaseResponse<MerchantCommodityDetailDTO> queryDetail(@RequestBody MerchantCommodityDetail4CRequest request): 该方法用于处理商品详情查询的请求。接收一个请求体为MerchantCommodityDetail4CRequest类型的参数，并返回一个BaseResponse类型的对象，其中泛型为MerchantCommodityDetailDTO，表示商品详情的数据结构。
方法逻辑：

* 调用merchantCommodity4CFacade的queryDetail方法，传递request参数，然后将其结果直接返回。
总体而言，这段代码定义了一个RESTful风格的控制器类，提供了商品详情查询的接口，具体的业务逻辑实现委托给了MerchantCommodity4CFacade类。这个控制器主要用于处理关于商户商品的一些HTTP请求。在总结文档中，你可能需要补充一些关于MerchantCommodity4CFacade和其他相关类的信息，以便更全面地理解系统。


### facde 门面查询服务


```java
package com.nio.vas.matrix.application.carserve.facade.commodity;

import com.nio.ngfs.common.model.BaseResponse;
import com.nio.vas.matrix.api.model.carserve.commodity.request.MerchantCommodityDetail4CRequest;
import com.nio.vas.matrix.api.model.carserve.commodity.request.MerchantCommodityDetailRequest;
import com.nio.vas.matrix.api.model.carserve.commodity.response.MerchantCommodityDetailDTO;

public interface MerchantCommodity4CFacade {


    /**
     * 查询商户商品详情
     *
     * @param request 请求体
     * @author xuefei.xia
     * @date 2023/9/28 13:57
     **/
    BaseResponse<MerchantCommodityDetailDTO> queryDetail(MerchantCommodityDetail4CRequest request);
}

```

```java
包和导入：

package com.nio.vas.matrix.application.carserve.facade.commodity;: 声明了该接口所属的包。
导入了一些其他类，例如BaseResponse和一些与商户商品相关的请求和响应模型。
接口定义：

public interface MerchantCommodity4CFacade: 定义了一个名为MerchantCommodity4CFacade的接口。
接口方法：

BaseResponse<MerchantCommodityDetailDTO> queryDetail(MerchantCommodityDetail4CRequest request): 接口中声明了一个方法queryDetail，用于查询商户商品的详情。该方法接收一个类型为MerchantCommodityDetail4CRequest的请求参数，并返回一个BaseResponse类型的对象，其中泛型为MerchantCommodityDetailDTO，表示商户商品的详情数据结构。
方法注释：

`/**
查询商户商品详情
@param request 请求体
@author xuefei.xia
@date 2023/9/28 13:57
**/: 通过注释提供了对queryDetail`方法的说明，包括参数和作者以及日期的信息。
总体而言，这个接口定义了商户商品相关的外观（Facade）接口，其中包含了查询商户商品详情的方法。在总结文档中，你可以说明这个接口的作用，以及它是如何与上一个代码段中的控制器类MerchantCommodity4CController配合工作的。此外，可能还需要进一步了解MerchantCommodityDetail4CRequest和MerchantCommodityDetailDTO这两个类的定义和结构。

```




### 4CFade接口实现类

```java
package com.nio.vas.matrix.application.carserve.facade.impl.commodity;

import com.nio.ngfs.common.model.BaseResponse;
import com.nio.vas.matrix.api.model.carserve.commodity.request.MerchantCommodityDetail4CRequest;
import com.nio.vas.matrix.api.model.carserve.commodity.response.MerchantCommodityDetailDTO;
import com.nio.vas.matrix.application.carserve.facade.commodity.MerchantCommodity4CFacade;
import com.nio.vas.matrix.application.carserve.facade.processor.commodity.MerchantCommodityDetail4CProcessor;
import com.nio.vas.matrix.application.template.VasBizServiceBase;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;


@Service
public class MerchantCommodity4CFacadeImpl extends VasBizServiceBase implements MerchantCommodity4CFacade {

    @Autowired
    private MerchantCommodityDetail4CProcessor merchantCommodityDetail4CProcessor;
    @Override
    public BaseResponse<MerchantCommodityDetailDTO> queryDetail(MerchantCommodityDetail4CRequest request) {
        return doBiz(request, this.merchantCommodityDetail4CProcessor, Boolean.FALSE, null);
    }
}

```




```java

这段代码是一个实现了MerchantCommodity4CFacade接口的类，名为MerchantCommodity4CFacadeImpl，是一个服务类的实现。以下是对代码的总结：

包和导入：

package com.nio.vas.matrix.application.carserve.facade.impl.commodity;: 定义了该类所在的包。
导入了一些其他类，包括BaseResponse、MerchantCommodityDetail4CRequest、MerchantCommodityDetailDTO等，用于处理商户商品相关的请求和响应。
类注解：

@Service: 声明这是一个Spring的服务类。
继承关系：

extends VasBizServiceBase: 继承了VasBizServiceBase类。
成员变量：

@Autowired private MerchantCommodityDetail4CProcessor merchantCommodityDetail4CProcessor;: 使用@Autowired注解进行自动装配，将MerchantCommodityDetail4CProcessor类型的Bean注入到该成员变量中。
接口实现方法：

@Override public BaseResponse<MerchantCommodityDetailDTO> queryDetail(MerchantCommodityDetail4CRequest request): 实现了MerchantCommodity4CFacade接口中的queryDetail方法。在该方法中，调用了doBiz方法，传递了request参数、merchantCommodityDetail4CProcessor处理器，以及其他一些参数。
方法逻辑：

return doBiz(request, this.merchantCommodityDetail4CProcessor, Boolean.FALSE, null);: 调用doBiz方法，该方法可能包含了一些通用的业务逻辑，用于处理商户商品详情的请求。
总体而言，这个类实现了MerchantCommodity4CFacade接口，提供了查询商户商品详情的具体实现。在总结文档中，你可以进一步说明这个类的作用，以及它是如何通过依赖注入和继承关系与其他类（如MerchantCommodityDetail4CProcessor和VasBizServiceBase）进行协作的。

```


### 处理Processor实现

```java
User
package com.nio.vas.matrix.application.carserve.facade.processor.commodity;

import com.google.common.collect.Lists;
import com.nio.ngfs.common.exception.BusinessException;
import com.nio.ngfs.common.model.BaseResponse;
import com.nio.vas.matrix.api.enums.UserTypeEnum;
import com.nio.vas.matrix.api.enums.YesOrNoEnum;
import com.nio.vas.matrix.api.enums.carserve.*;
import com.nio.vas.matrix.api.enums.coupon.CouponIssueStatusEnum;
import com.nio.vas.matrix.api.enums.coupon.CouponStatusEnum;
import com.nio.vas.matrix.api.model.carserve.commodity.request.MerchantCommodityDetail4CRequest;
import com.nio.vas.matrix.api.model.carserve.commodity.response.*;
import com.nio.vas.matrix.api.model.carserve.valueobject.AddressInfoDTO;
import com.nio.vas.matrix.api.resultcode.BaseResultCodeEnum;
import com.nio.vas.matrix.application.apollo.ParkingApolloSwitchConfig;
import com.nio.vas.matrix.application.carserve.assembler.MerchantAddressAssembler;
import com.nio.vas.matrix.application.carserve.assembler.MerchantCommodityAssembler;
import com.nio.vas.matrix.application.carserve.common.CarServeAction;
import com.nio.vas.matrix.application.template.VasAction;
import com.nio.vas.matrix.application.threadpool.ThreadPoolManager;
import com.nio.vas.matrix.domain.model.coupon.CouponDetailResponse;
import com.nio.vas.matrix.domain.model.coupon.CouponWrapper;
import com.nio.vas.matrix.domain.model.coupon.enums.CouponClassificationEnum;
import com.nio.vas.matrix.domain.model.coupon.enums.CouponDisplayTypeEnum;
import com.nio.vas.matrix.domain.model.domain.carserve.*;
import com.nio.vas.matrix.domain.model.domain.carserve.valueobject.GiftInfo;
import com.nio.vas.matrix.domain.model.domain.common.Address;
import com.nio.vas.matrix.domain.model.domain.common.Attachment;
import com.nio.vas.matrix.domain.model.equity.EquityStockDTO;
import com.nio.vas.matrix.domain.model.equity.ServicePackageVersion;
import com.nio.vas.matrix.domain.model.user.User;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.collections4.CollectionUtils;
import org.apache.commons.lang3.StringUtils;
import org.apache.commons.lang3.tuple.Pair;
import org.apache.commons.lang3.tuple.Triple;
import org.springframework.stereotype.Service;
import java.math.BigDecimal;
import java.util.*;
import java.util.concurrent.ExecutionException;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Future;

import static com.nio.vas.matrix.domain.constants.carserve.order.CarServeOrderConstants.OLD_COUPON_WASH_COMMODITY_ID;


@Service
@Slf4j
public class MerchantCommodityDetail4CProcessor extends AbstractMerchantCommodity4CProcessor<MerchantCommodityDetail4CRequest, BaseResponse<MerchantCommodityDetailDTO>>{
    
    protected ExecutorService executorService = ThreadPoolManager.TASK_THREAD_POOL;

    @Override
    public VasAction getAction() {
        return CarServeAction.QUERY_MERCHANT_COMMODITY_DETAIL_FOR_C;
    }

    @Override
    public BaseResponse<MerchantCommodityDetailDTO> initResult(MerchantCommodityDetail4CRequest order) {
        BaseResponse<MerchantCommodityDetailDTO> result = new BaseResponse<>();
        result.setResultCode(BaseResultCodeEnum.SUCCESS.getCode());
        result.setDisplayMsg(BaseResultCodeEnum.SUCCESS.getMessage());
        return result;
    }

    @Override
    public void doExecute(MerchantCommodityDetail4CRequest request, BaseResponse<MerchantCommodityDetailDTO> result) {
        final String mcNo = request.getMerchantCommodityNo();
        final String vehicleId = request.getVehicleId();
        final Date consumeDate = new Date();
        final String currAccountId = this.getUserAccountId();   //     final String currAccountId = "107338046";

        // 商品信息
        final MerchantCommodity merchantCommodity = this.getMerchantCommodity(mcNo, Boolean.TRUE, Boolean.TRUE, Boolean.TRUE,Boolean.TRUE);

        if(merchantCommodity == null){
            return;
        }

        // 标准商品信息
        StandardCommodity  standardCommodity = merchantCommodity.getStandardCommodity();

        // 商户信息
        Merchant merchant = merchantCommodity.getMerchant();

        // 商户地址信息
        Future<Address<CarServeAddressTypeEnum>> merchantAddressFuture = this.selectAddressByMerchantNoAsync(merchant.getMerchantNo());

         // 获取服务包信息  查询用户类型
        Future<ServicePackageVersion.ServicePackage> servicePackageFuture = null;
        if(StringUtils.isNotEmpty(vehicleId)) servicePackageFuture = this.getCurrentServicePackageAsync(vehicleId);

        // 获取可用卡券信息 只获取未使用卡券
        List<String> couponStatusList = Lists.newArrayList(CouponStatusEnum.UNUSED.getCode().toString());
        List<String> commodityIds = Lists.newArrayList(OLD_COUPON_WASH_COMMODITY_ID, merchantCommodity.getStandardCommodity().getCategoryNo());
        Future<List<CouponWrapper>> couponWrappersFuture = this.queryCouponsAsync(currAccountId, couponStatusList, commodityIds);

        // 获取剩余权益信息
        Future<EquityStockDTO> equityStockFuture = null;
        if(StringUtils.isNotEmpty(vehicleId)) equityStockFuture = this.getEquityStockAsync(vehicleId, currAccountId, consumeDate);

        // 图片附件信息查询
        Future<List<Attachment<CarServeAttachmentSceneTypeEnum>>> attachmentsStandardAsync = this.getAttachmentsImageAsync(standardCommodity.getStandardCommodityNo(),
                Lists.newArrayList(CarServeAttachmentSceneTypeEnum.STANDARD_COMMODITY_IMG,CarServeAttachmentSceneTypeEnum.STANDARD_COMMODITY_HEADER,CarServeAttachmentSceneTypeEnum.STANDARD_COMMODITY_OTHERS));
        Future<List<Attachment<CarServeAttachmentSceneTypeEnum>>> attachmentsServiceAsync = this.getAttachmentsImageAsync(mcNo,Lists.newArrayList(CarServeAttachmentSceneTypeEnum.COMMODITY_SERVICE_DETAIL));

        List<CouponWrapper> couponWrappers = null;
        ServicePackageVersion.ServicePackage servicePackage = null;
        EquityStockDTO equityStock = null;

        try {
            servicePackage = Objects.nonNull(servicePackageFuture) ? servicePackageFuture.get() : null;
            couponWrappers = Objects.nonNull(couponWrappersFuture) ? couponWrappersFuture.get() : null;
            equityStock = Objects.nonNull(equityStockFuture) ? equityStockFuture.get() : null;
        } catch (InterruptedException e) {
            log.error("MerchantCommodityDetail4CProcessor occurs InterruptedException", e);
        } catch (ExecutionException e) {
            log.error("MerchantCommodityDetail4CProcessor occurs ExecutionException", e);
        }catch (BusinessException e){
            log.error("MerchantCommodityDetail4CProcessor occurs BusinessException", e);
        }catch (Exception e){
            log.error("MerchantCommodityDetail4CProcessor occurs Exception", e);
        }

        // 获取当前用户类型：有包 or 非包
        UserTypeEnum userType = Objects.nonNull(servicePackage)
                ? UserTypeEnum.USER_WITH_RIGHTS_INTERESTS : UserTypeEnum.USER_WITHOUT_RIGHTS_INTERESTS;

        // 获取所有活动
        List<Campaign> availCampaigns = this.listAvailCampaigns(currAccountId, userType, mcNo
                , /*Lists.newArrayList(CampaignTypeEnum.SUBSTACT.getCode(), CampaignTypeEnum.DISCOUNT.getCode())*/null
                , consumeDate);

        // 计算优惠金额以及对应活动
        Pair<BigDecimal, Map<Campaign, Object>> discountPair = this.calculateDiscount(availCampaigns
                , merchantCommodity.getSalePrice(), null, null);

        MerchantCommodityDetailDTO mcDTO = this.buildDTO(merchant,merchantCommodity,attachmentsStandardAsync
                , attachmentsServiceAsync,standardCommodity,merchantAddressFuture,couponWrappers,equityStock,discountPair);
        result.setData(mcDTO);
    }

    /**
     * 组装信息
     * @param merchant
     * @param merchantCommodity
     * @param attachmentsStandardAsync
     * @param standardCommodity
     * @param merchantAddressAsync
     * @param couponWrappers
     * @param equityStock
     * @param discountPair
     */
    private MerchantCommodityDetailDTO  buildDTO(Merchant merchant,MerchantCommodity merchantCommodity,Future<List<Attachment<CarServeAttachmentSceneTypeEnum>>> attachmentsStandardAsync ,
                                                 Future<List<Attachment<CarServeAttachmentSceneTypeEnum>>> attachmentsServiceAsync,
                                                 StandardCommodity standardCommodity,
    Future<Address<CarServeAddressTypeEnum>> merchantAddressAsync,List<CouponWrapper> couponWrappers,EquityStockDTO equityStock,Pair<BigDecimal, Map<Campaign, Object>> discountPair){
        MerchantCommodityDetailDTO mcDTO = new MerchantCommodityDetailDTO();

        // 商户相关信息
        mcDTO.setMerchantNo(merchant.getMerchantNo());
        mcDTO.setMerchantName(merchant.getMerchantName());
        mcDTO.setMerchantPhoneNumber(merchant.getContactPhone());
        mcDTO.setBusinessStatus(merchant.getBusinessStatus().getCode());
        mcDTO.setBusinessStartTime(merchant.getBusinessStartTime());
        mcDTO.setBusinessEndTime(merchant.getBusinessEndTime());

        // 商户地址信息
        Address<CarServeAddressTypeEnum> carServeAddressTypeEnumAddress = null;
        try {
            carServeAddressTypeEnumAddress = merchantAddressAsync.get();
            if(carServeAddressTypeEnumAddress != null){
                AddressInfoDTO addressInfoDTO = MerchantAddressAssembler.INSTANCE.convert2DTO(carServeAddressTypeEnumAddress);
                mcDTO.setAddress(addressInfoDTO);
            }
        } catch (InterruptedException e) {
            log.error("MerchantCommodityDetail4CProcessor occurs InterruptedException", e);
        } catch (ExecutionException e) {
            log.error("MerchantCommodityDetail4CProcessor occurs Exception", e);
        }catch (BusinessException e){
            log.error("MerchantCommodityDetail4CProcessor occurs BusinessException", e);
        }catch (Exception e){
            log.error("MerchantCommodityDetail4CProcessor occurs Exception", e);
        }


        // 商品活动信息
        List<CampaignInfoDTO> campaignsInfoDTOList = new ArrayList<>();
        BigDecimal totalDiscountAmount = null;
        if(Objects.nonNull(discountPair)){
            totalDiscountAmount = discountPair.getLeft();
            Map<Campaign, Object> campaignDiscountMap = discountPair.getRight();
            campaignDiscountMap.keySet().forEach(campaign -> {
                Object discountObj = campaignDiscountMap.get(campaign);
                BigDecimal discountAmount = null;

                // 遍历每一种活动构建信息
                CampaignInfoDTO campaignsInfoDTO = new CampaignInfoDTO();
                campaignsInfoDTO.setCampaignNo(campaign.getCampaignNo());
                campaignsInfoDTO.setCampaignName(campaign.getCampaignName());
                campaignsInfoDTO.setCampaignDisplayName(campaign.getCampaignDisplayName());
                campaignsInfoDTO.setType(campaign.getType().getCode());
                campaignsInfoDTO.setSubType(campaign.getSubType().getCode());
                campaignsInfoDTO.setFulfilQuota(campaign.getFulfilQuota());
                campaignsInfoDTO.setFufilQuotaType(campaign.getFufilQuotaType().getCode());
                campaignsInfoDTO.setCampaignDesc(campaign.getCampaignDesc());// 活动说明
                campaignsInfoDTO.setDiscountAmount(campaign.getDiscountAmount());

                List<GiftInfoDTO> destinationGiftInfo = new ArrayList<>();
                if(campaign.getGiftInfo() != null){
                    for(GiftInfo giftInfo:campaign.getGiftInfo()){
                        GiftInfoDTO giftInfoDTO = new GiftInfoDTO();
                        giftInfoDTO.setGiftName(giftInfo.getGiftName());
                        giftInfoDTO.setGiftType(giftInfo.getGiftType());
                        giftInfoDTO.setGiftNo(giftInfo.getGiftNo());
                        giftInfoDTO.setGiftUrl(giftInfo.getGiftUrl());
                        destinationGiftInfo.add(giftInfoDTO);
                    }
                }
                campaignsInfoDTO.setGiftInfo(destinationGiftInfo);

                if(Lists.newArrayList(CampaignTypeEnum.SUBSTACT)
                        .contains(campaign.getType())) {
                    discountAmount = (BigDecimal) discountObj;
                    // 减价活动的减免金额
                    if(Lists.newArrayList(CampaignTypeEnum.SUBSTACT.getCode())
                            .contains(campaignsInfoDTO.getType())){
                        campaignsInfoDTO.setReductionAmount(discountAmount);
                    }

                }
                if(Lists.newArrayList(CampaignTypeEnum.DISCOUNT)
                        .contains(campaign.getType())) {
                    discountAmount = (BigDecimal) discountObj;
                    // 折价活动的减免金额
                    if(Lists.newArrayList(CampaignTypeEnum.DISCOUNT.getCode())
                            .contains(campaignsInfoDTO.getType())){
                        campaignsInfoDTO.setReductionAmount(discountAmount);
                    }
                }
                campaignsInfoDTOList.add(campaignsInfoDTO);
            });
        }
        mcDTO.setCampaigns(campaignsInfoDTOList);


        // 商品相关信息
        mcDTO.setSalePrice(merchantCommodity.getSalePrice());
        // 优惠金额
        if(totalDiscountAmount != null){
            mcDTO.setTotalDiscountAmount(totalDiscountAmount);
            // 优惠价
            mcDTO.setDiscountPrice(mcDTO.getSalePrice().subtract(mcDTO.getTotalDiscountAmount()));
        }else{
            // 没优惠金额 就是原价
            mcDTO.setDiscountPrice(mcDTO.getSalePrice());
        }
        mcDTO.setCommodityNo(merchantCommodity.getCommodityNo());
        mcDTO.setCommodityName(merchantCommodity.getCommodityName());
        mcDTO.setNotes(merchantCommodity.getNotes());
        mcDTO.setApplyVehicle(merchantCommodity.getApplyVehicle());
        mcDTO.setIsAdvanceBook(merchantCommodity.getIsNeedAppoint() == YesOrNoEnum.YES ? true: false);
        mcDTO.setCreditLimit(merchantCommodity.getCreditLimit());
        mcDTO.setMaxCredit((mcDTO.getDiscountPrice().multiply(ParkingApolloSwitchConfig.POINTS_EXCHANGE_AMOUNT_RATIO)).intValue());
        mcDTO.setServiceDetail(merchantCommodity.getServiceDetail());


        // 图片附件
        try {
            List<Attachment<CarServeAttachmentSceneTypeEnum>> attachmentsStandard = attachmentsStandardAsync.get();
            List<Attachment<CarServeAttachmentSceneTypeEnum>> attachmentsService =  attachmentsServiceAsync.get();
            List<Attachment<CarServeAttachmentSceneTypeEnum>> attachments = new ArrayList<>();
            attachments.addAll(attachmentsService);
            attachments.addAll(attachmentsStandard);
            if(attachments != null){
                mcDTO.setAttachments(MerchantCommodityAssembler.INSTANCE.assemblerAttachment2ImgDTOs(attachments));
            }
        } catch (InterruptedException e) {
            log.error("MerchantCommodityDetail4CProcessor occurs InterruptedException", e);
        } catch (ExecutionException e) {
            log.error("MerchantCommodityDetail4CProcessor occurs Exception", e);
        }catch (BusinessException e){
            log.error("MerchantCommodityDetail4CProcessor occurs BusinessException", e);
        }catch (Exception e){
            log.error("MerchantCommodityDetail4CProcessor occurs Exception", e);
        }

        // 标准商品信息
        mcDTO.setStandardCommodityNo(standardCommodity.getStandardCommodityNo());
        mcDTO.setStandardCommodityName(standardCommodity.getStandardCommodityName());
        mcDTO.setCommoditySubName(standardCommodity.getSubTitle());
        if(mcDTO.getServiceDetail() == null || mcDTO.getServiceDetail().isEmpty()){
            // 如果服务详情说明没有 使用标准商品说明
            mcDTO.setServiceDetail(standardCommodity.getServiceIntroduction());
        }
        // 购买须知的有效期信息
        mcDTO.setEffectDays(standardCommodity.getEffectDays());
        StandardCommodityCategory standardCommodityCategory = standardCommodity.getStandardCommodityCategory();
        mcDTO.setCommoditySimpleName(standardCommodityCategory.getDisplayName());


        // 洗车券信息  取出面额最大的
        BigDecimal orderAmount = mcDTO.getDiscountPrice(); // 订单金额


        Triple<List<CouponWrapper>, List<CouponWrapper>, List<CouponWrapper>> outCouponsTriple = this.filterOutCoupons(couponWrappers, orderAmount);
        List<CouponWrapper> availOutCoupons = outCouponsTriple.getLeft();


        CouponWashDTO couponWashDTO = calculateMaxCouponPrice(availOutCoupons);

        if(couponWashDTO != null){
            mcDTO.setWashCoupon(couponWashDTO);
        }

        // 增值券信息
        RightsInterestCouponDTO rightsInterestCouponDTO = new RightsInterestCouponDTO();
        if(equityStock != null){
            rightsInterestCouponDTO.setStockCode(equityStock.getStockCode());
            rightsInterestCouponDTO.setValidInCurrent(equityStock.getValidInCurrent());
            rightsInterestCouponDTO.setTotalAmount(equityStock.getTotalAmount());
            rightsInterestCouponDTO.setResidualAmount(equityStock.getResidualAmount());
        }
        mcDTO.setRightsInterestCoupon(rightsInterestCouponDTO);

        return mcDTO;
    }

    /**
     * 计算最大面值卡券
     * @param outCoupons
     * @return
     */
    protected CouponWashDTO calculateMaxCouponPrice(List<CouponWrapper> outCoupons) {
        if (CollectionUtils.isNotEmpty(outCoupons)) {// 待核销卡券
            BigDecimal maxAmount = BigDecimal.ZERO;
            String maxCouponName = null;

            for (CouponWrapper outCoupon : outCoupons) {
                CouponDisplayTypeEnum displayType = CouponDisplayTypeEnum.getByCode(outCoupon.getDisplay());
                if(displayType == CouponDisplayTypeEnum.PRICE) {// 现金
                    BigDecimal currentCreditPrice = BigDecimal.valueOf(outCoupon.getCreditPrice()).divide(BigDecimal.valueOf(100));
                    if(maxAmount.compareTo(currentCreditPrice) < 0){
                        maxAmount = currentCreditPrice;
                        maxCouponName = outCoupon.getCouponName();
                    }

                } else if (displayType == CouponDisplayTypeEnum.CREDIT) {// 积分
                    BigDecimal currentCreditPrice = BigDecimal.valueOf(outCoupon.getCreditPrice()).divide(ParkingApolloSwitchConfig.POINTS_EXCHANGE_AMOUNT_RATIO);
                    if(maxAmount.compareTo(currentCreditPrice) < 0){
                        maxAmount = currentCreditPrice;
                        maxCouponName = outCoupon.getCouponName();
                    }

                }
            }
            CouponWashDTO couponWashDTO = new CouponWashDTO();
            couponWashDTO.setCreditPrice(maxAmount.intValue());
            couponWashDTO.setCouponName(maxCouponName);
            return couponWashDTO;
        }
        return null;
    }


    /**
     * 异步获取商品图片附件
     * @param
     * @return
     */
    private Future<List<Attachment<CarServeAttachmentSceneTypeEnum>>> getAttachmentsImageAsync(String mcNo,List<CarServeAttachmentSceneTypeEnum> sceneTypeEnums){
        return this.executorService.submit(() -> attachmentRepository.selectHeaderAndServiceImgAttachment(mcNo,sceneTypeEnums));
    }

    /**
     * 查询服务包信息
     * @param vehicleId
     * @return
     */
    protected ServicePackageVersion.ServicePackage getCurrentServicePackage(String vehicleId) {
        ServicePackageVersion.ServicePackage servicePackage = this.equityAdapter.getCurrentServicePackage(vehicleId);
        return servicePackage;
    }


    /**
     * 异步查询获取商家地址信息
     * @param merchantNo
     * @return
     */
    private Future<Address<CarServeAddressTypeEnum>> selectAddressByMerchantNoAsync(String merchantNo) {
        return this.executorService.submit(() -> addressRepository.selectMerchantAddressByBizNo(merchantNo));
    }
}

```


```java
这段代码是一个处理商户商品详情查询的处理器类，名为MerchantCommodityDetail4CProcessor。以下是对代码的总结：

包和导入：

package com.nio.vas.matrix.application.carserve.facade.processor.commodity;: 定义了该类所在的包。
导入了一系列的类，包括异常处理、各种枚举、请求和响应模型、业务逻辑相关的类、线程池管理、日志记录等。
类注解：

@Service: 表示这是一个Spring的服务类。
继承关系：

extends AbstractMerchantCommodity4CProcessor<MerchantCommodityDetail4CRequest, BaseResponse<MerchantCommodityDetailDTO>>: 继承了一个抽象类，并指定了泛型参数。
成员变量：

private ExecutorService executorService = ThreadPoolManager.TASK_THREAD_POOL;: 定义了一个线程池。
接口实现方法：

getAction(): 实现了AbstractMerchantCommodity4CProcessor中的getAction方法，返回一个枚举值表示处理的动作类型。
initResult(): 实现了AbstractMerchantCommodity4CProcessor中的initResult方法，初始化并返回一个BaseResponse<MerchantCommodityDetailDTO>对象。
doExecute(): 实现了AbstractMerchantCommodity4CProcessor中的doExecute方法，处理具体的业务逻辑。在该方法中，通过调用一系列的异步方法，获取商品、商户、服务包、卡券等信息，然后组装成一个MerchantCommodityDetailDTO对象，最终设置到BaseResponse中返回。
异步方法：

getAttachmentsImageAsync(): 异步获取商品图片附件的方法。
selectAddressByMerchantNoAsync(): 异步查询获取商家地址信息的方法。
具体业务逻辑方法：

calculateMaxCouponPrice(): 计算最大面值卡券的方法。
buildDTO(): 组装信息的方法，构建了MerchantCommodityDetailDTO对象。
getCurrentServicePackage(): 查询服务包信息的方法。
异常处理：

在异步方法中使用try-catch块捕获异常，并记录日志。
总体而言，这个处理器类负责处理商户商品详情查询的业务逻辑，通过异步方法获取各种信息，然后进行组装，最终返回一个BaseResponse对象，其中包含了MerchantCommodityDetailDTO对象。在总结文档中，你可能需要详细说明该类的作用，以及它是如何与其他类（如MerchantCommodity4CFacadeImpl、VasBizServiceBase等）协作的。

```



### 门面设计模式




* 上述代码中使用了门面设计模式。在面向对象设计中，门面设计模式（Facade Design Pattern）提供了一个高层次的接口，使得系统更易于使用。在这个情境中，MerchantCommodity4CFacade 接口充当了门面，而MerchantCommodity4CFacadeImpl 类实现了这个门面接口，提供了一种简化和统一的方式来查询商户商品的详情。

* 门面设计模式的优点在于它隐藏了系统的复杂性，为客户端提供了一个简化的接口。在这里，客户端通过调用 MerchantCommodity4CFacade 接口的 queryDetail 方法来查询商户商品的详情，而不需要了解底层的具体实现细节。这种设计可以降低系统的耦合度，使得系统更加灵活和易于维护。

* 因此，可以说上述代码中使用了门面设计模式，通过 MerchantCommodity4CFacade 接口提供了一个简化的入口点，将客户端和具体实现解耦，提高了系统的可维护性和可扩展性。

### 流程总结


```

整个处理流程涉及多个类和接口，其中门面设计模式主要体现在MerchantCommodity4CFacade 接口及其实现类 MerchantCommodity4CFacadeImpl 上。以下是整个处理流程的梳理：

Controller层：

MerchantCommodity4CController 类是一个Spring的REST控制器，负责接收前端请求并转发到后端处理。
Facade接口层：

MerchantCommodity4CFacade 接口定义了一个查询商户商品详情的方法 queryDetail。
Facade实现层：

MerchantCommodity4CFacadeImpl 类实现了 MerchantCommodity4CFacade 接口，是门面的具体实现。
该类注入了一个处理器类 MerchantCommodityDetail4CProcessor。
Processor层：

MerchantCommodityDetail4CProcessor 类是一个处理器类，负责处理商户商品详情的具体业务逻辑。
实现了 AbstractMerchantCommodity4CProcessor 抽象类，其中定义了异步方法、具体业务逻辑的执行方法等。
通过调用异步方法和其他服务，获取商户、商品、服务包、卡券等信息，并将它们组装成 MerchantCommodityDetailDTO 对象。
该类作为门面实现中的一部分，提供了高层次的接口。
其他类：

多个枚举类、请求和响应模型、服务类、工具类等，用于支持业务逻辑的实现。
整个处理流程的关键点如下：

Controller层接收请求，调用MerchantCommodity4CFacade 接口。
MerchantCommodity4CFacadeImpl 实现了门面接口，注入了处理器类 MerchantCommodityDetail4CProcessor。
MerchantCommodityDetail4CProcessor 处理器类实现了具体的业务逻辑，包括异步方法的调用、信息的获取和组装。
MerchantCommodityDetail4CProcessor 的异步方法利用线程池进行并发执行，提高系统的并发处理能力。
最终，MerchantCommodityDetail4CProcessor 返回一个包含商户商品详情信息的 BaseResponse<MerchantCommodityDetailDTO> 对象。
这样的设计体现了门面设计模式，通过 MerchantCommodity4CFacade 接口提供了一个简化的入口点，隐藏了底层系统的复杂性，提高了系统的可维护性和可扩展性。

```



### 异步方法实现

```java
MerchantCommodityDetail4CProcessor 处理器类的设计体现了一种异步处理模式，其中异步方法的调用、信息的获取和组装都是关键的组成部分。以下是这种设计的好处和优势：

提高并发性能：

异步方法的调用通过线程池进行并发执行，允许系统同时处理多个任务。这可以提高系统的并发性能，尤其在处理大量请求时表现更为出色。
减少阻塞时间：

异步调用避免了同步操作的阻塞，允许系统在等待某些资源或服务响应的同时执行其他任务。这有助于减少整体处理时间，提高系统的响应速度。
资源利用率优化：

通过异步方法，系统可以更有效地利用资源，不会因为等待某些任务的完成而浪费资源。线程池管理可以灵活控制并发任务的数量，避免资源过度占用。
提高系统可伸缩性：

异步处理允许系统更好地应对负载增加的情况。在高并发情况下，系统能够更灵活地处理请求，而不至于过度负荷。
系统解耦和模块化：

异步设计有助于系统的解耦，各个模块之间不需要过多的关注对方的处理时间。这样，系统的各个部分可以独立演进和维护，提高了模块的可重用性和可维护性。
容错性提高：

异步方法的执行在一定程度上提高了系统的容错性。如果某个异步任务发生异常，不会影响到其他任务的正常执行，系统可以更灵活地处理异常情况。
避免UI阻塞（对于Web应用等）：

在某些应用场景，比如Web应用中，异步设计可以避免前端界面的阻塞，用户体验更加流畅。例如，可以异步地加载一些耗时的数据，而不阻塞用户界面的其他操作。
总的来说，采用异步设计的 MerchantCommodityDetail4CProcessor 处理器类能够优化系统的性能、资源利用和响应速度，同时提高系统的可维护性和可伸缩性。

```






