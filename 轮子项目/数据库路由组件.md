# 自定义数据库路由组件

## DBRouterConfig


```java
package cn.bugstack.middleware.db.router;


/**
 * 数据路由配置   定义一个名为DBRouterConfig的数据库路由配置
 * 分库数量 表示数据库被划分为多少个子库
 * 分表数量  表示每一个库中表的分表数量
 * routerKey路由字段 决定数据将被路由到哪一个数据库或者哪一个表中
 */
public class DBRouterConfig {

    /**
     * 分库数量
     */
    private int dbCount;

    /**
     * 分表数量
     */
    private int tbCount;

    /**
     * 路由字段
     */
    private String routerKey;

    public DBRouterConfig() {
    }

    public DBRouterConfig(int dbCount, int tbCount, String routerKey) {
        this.dbCount = dbCount;
        this.tbCount = tbCount;
        this.routerKey = routerKey;
    }


    public int getDbCount() {
        return dbCount;
    }

    public void setDbCount(int dbCount) {
        this.dbCount = dbCount;
    }

    public int getTbCount() {
        return tbCount;
    }

    public void setTbCount(int tbCount) {
        this.tbCount = tbCount;
    }

    public String getRouterKey() {
        return routerKey;
    }

    public void setRouterKey(String routerKey) {
        this.routerKey = routerKey;
    }
}

```


## DBRouterBase


```java

package cn.bugstack.middleware.db.router;

/**
 * 数据源基础配置
 * 主要用来获取当前线程锁指定的表索引tbIdx
 *
 * 使用线程局部变量ThreadLocal 来存储每一个线程独有的数据库表索引
 */
public class DBRouterBase {

    private String tbIdx;


    public String getTbIdx(){
        return DBContextHolder.getTBKey();// 获取当前线程中指定的表索引
    }


}

```



## DBContextHolder


```java
package cn.bugstack.middleware.db.router;

/**
 * 数据源上下文  管理数据库上下文信息  保证并发场景下 每一个线程可以安全访问自己专属的数据库表的索引
 * 负责在当前上下文保存和管理数据库db和tb的键值信息  用于动态数据源路由的实现
 * 该类主要为每一个线程独立存储数据库键值信息  保证多线程环境下的线程安全  每一个线程只能范围跟自己的数据库键和表键 不受其他线程干扰
 */
public class DBContextHolder {
    // 当前线程上下文中保存和管理数据库键值信息

    private static final ThreadLocal<String> dbKey = new ThreadLocal<>();
    private static final ThreadLocal<String> tbKey = new ThreadLocal<>();

    // 设置当前线程的数据库键和表键信息
    public static  void setDbKey(String dbKeyIdx){
        dbKey.set(dbKeyIdx);
    }

    /**
     *
     * @return
     */
    public static  String getDbKey(){
        return dbKey.get();
    }


    public static void setTBKey(String tbKeyIdx){
        tbKey.set(tbKeyIdx);
    }

    public static String getTBKey(){
        return tbKey.get();
    }


}


```




