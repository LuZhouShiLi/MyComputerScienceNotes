# æŠ½å¥–ç³»ç»Ÿç»†èŠ‚æè¿°


## é¢†å–æ´»åŠ¨é¢†åŸŸå¼€å‘-ä½œä¸ºæ´»åŠ¨é¢†åŸŸçš„ä¸€ä¸ªå­é¢†åŸŸ


**åŸºäºæ¨¡æ¿æ¨¡å¼å¼€å‘é¢†å–æ´»åŠ¨é¢†åŸŸï¼Œå› ä¸ºåœ¨é¢†å–æ´»åŠ¨ç§éœ€è¦è¿›è¡Œæ´»åŠ¨çš„æ—¥æœŸï¼Œåº“å­˜ï¼ŒçŠ¶æ€ç­‰æ ¡éªŒï¼Œå¹¶ä¸”å¤„ç†æ‰£å‡åº“å­˜ï¼Œæ·»åŠ æ´»åŠ¨é¢†å–ä¿¡æ¯ï¼Œå°è£…ç»“æœç­‰ä¸€ç³»åˆ—æµç¨‹æ“ä½œï¼Œå› æ­¤ä½¿ç”¨æŠ½è±¡ç±»å®šä¹‰æ¨¡æ¿æ¨¡å¼æ›´åŠ å¦¥å½“**



### æŠ½å¥–æ´»åŠ¨å‚ä¸æ¥å£-æ¨¡æ¿æ¨¡å¼è®¾è®¡


* REQï¼šä¼ å…¥ç”¨æˆ·id æ´»åŠ¨Id  æ´»åŠ¨é¢†å–æ—¶é—´
* æŸ¥è¯¢æ´»åŠ¨è´¦å•
* æ´»åŠ¨ä¿¡æ¯æ ¡éªŒå’Œå¤„ç†  æ ¡éªŒæ´»åŠ¨çŠ¶æ€ æ ¡éªŒæ´»åŠ¨æ—¥æœŸ æ ¡éªŒæ´»åŠ¨åº“å­˜ 
* æ‰£å‡æ´»åŠ¨åº“å­˜
* é¢†å–æ´»åŠ¨ä¿¡æ¯ = æ‰£å‡ä¸ªäººå‚ä¸æ¬¡æ•° + æ’å…¥é¢†å–æ´»åŠ¨ä¿¡æ¯,æ’å…¥é¢†å–æ´»åŠ¨ä¿¡æ¯  å¦‚æœæ‰£å‡æˆåŠŸ é‚£ä¹ˆç”Ÿæˆä¸€ä¸ªæ–°çš„å”¯ä¸€ID ä½¿ç”¨é›ªèŠ±ç®—æ³•ç”Ÿæˆ
* å°è£…ç»“æœ è¿”å›çš„ç­–ç•¥ID é¢†å–å®Œæˆ ç”¨äºç»§ç»­å®ŒæˆæŠ½å¥–æ­¥éª¤

* IActivityPartake
```java
package cn.itedus.lottery.domain.activity.service.partake;

import cn.itedus.lottery.domain.activity.model.req.PartakeReq;
import cn.itedus.lottery.domain.activity.model.res.PartakeResult;

/**
 * @description: æŠ½å¥–æ´»åŠ¨å‚ä¸æ¥å£
 */
public interface IActivityPartake {

    /**
     * å‚ä¸æ´»åŠ¨
     * @param req  å…¥å‚
     * @return  é¢†å–ç»“æœ
     */
    PartakeResult doPartake(PartakeReq req);

}

```

* BaseActivityPartake


```java
package cn.itedus.lottery.domain.activity.service.partake;

import cn.itedus.lottery.common.Constants;
import cn.itedus.lottery.common.Result;
import cn.itedus.lottery.domain.activity.model.req.PartakeReq;
import cn.itedus.lottery.domain.activity.model.res.PartakeResult;
import cn.itedus.lottery.domain.activity.model.vo.ActivityBillVO;
import org.apache.tomcat.util.bcel.Const;

/**
 * æ´»åŠ¨é¢†å–æ¨¡æ¿æŠ½è±¡ç±»
 * å…ˆé€šè¿‡çˆ¶ç±»æä¾›çš„æ•°æ®æœåŠ¡  è·å–åˆ°æ´»åŠ¨è´¦å•  ç„¶åå†å®šä¹‰ä¸‰ä¸ªæŠ½è±¡æ–¹æ³•  æ´»åŠ¨ä¿¡æ¯æ ¡éªŒå¤„ç†  æ‰£å‡æ´»åŠ¨åº“å­˜  é¢†å–æ´»åŠ¨ ä¾æ¬¡é¡ºåºè§£å†³æ´»åŠ¨çš„é¢†å–æ“ä½œ
 *
 */
public abstract  class BaseActivityPartake extends ActivityPartakeSupport implements IActivityPartake{

    public PartakeResult doPartake(PartakeReq req){

        // æŸ¥è¯¢æ´»åŠ¨è´¦å•
        ActivityBillVO activityBillVO = super.queryActivityBill(req);

        // æ´»åŠ¨ä¿¡æ¯æ ¡éªŒå¤„ç† æ´»åŠ¨åº“å­˜ çŠ¶æ€æ—¥æœŸ ä¸ªäººå‚ä¸æ¬¡æ•°
        Result checkResult = this.checkActivityBill(req,activityBillVO);//
        if(!Constants.ResponseCode.SUCCESS.getCode().equals(checkResult.getCode())){

            // å¦‚æœçŠ¶æ€ç ä¸ä¸€è‡´
            return new PartakeResult(checkResult.getCode(),checkResult.getInfo());
        }

        // æ‰£å‡æ´»åŠ¨åº“å­˜
        Result subtractionActivityResult = this.subtractionActivityStock(req);// æ‰£å‡äº’åŠ¨åº“å­˜
        if(!Constants.ResponseCode.SUCCESS.getCode().equals(checkResult.getCode())){
            return new PartakeResult(subtractionActivityResult.getCode(),subtractionActivityResult.getInfo());
        }

        // é¢†å–æ´»åŠ¨ä¿¡æ¯
        Result grabResult = this.grabActivity(req,activityBillVO);
        if(!Constants.ResponseCode.SUCCESS.getCode().equals(grabResult.getCode())){
            return new PartakeResult(grabResult.getCode(),grabResult.getInfo());
        }

        // å°è£…ç»“æœ
        PartakeResult partakeResult = new PartakeResult(Constants.ResponseCode.SUCCESS.getCode(), Constants.ResponseCode.SUCCESS.getInfo());
        partakeResult.setStrategyId(activityBillVO.getStrategyId());
        return partakeResult;
    }

    /**
     * æ´»åŠ¨ä¿¡æ¯æ ¡éªŒå¤„ç† æŠŠæ´»åŠ¨åº“å­˜çŠ¶æ€ æ—¥æœŸ ä¸ªäººå‚ä¸æ¬¡æ•°
     * @param partake  å‚ä¸æ´»åŠ¨è¯·æ±‚
     * @param bill  æ´»åŠ¨è´¦å•
     * @return  æ ¡éªŒç»“æœ
     */
    protected abstract Result checkActivityBill(PartakeReq partake, ActivityBillVO bill);

    /**
     * æ‰£å‡æ´»åŠ¨å¯åº“å­˜
     * @param req  å‚ä¸æ´»åŠ¨è¯·æ±‚
     * @return
     */
    protected abstract Result subtractionActivityStock(PartakeReq req);


    /**
     * é¢†å–æ´»åŠ¨
     * @param partakeReq
     * @param bill  æ´»åŠ¨æµæ°´è´¦å•
     * @return
     */
    protected abstract Result grabActivity(PartakeReq partakeReq, ActivityBillVO bill);
}


```


* ActivityPartakeSupport
```java
package cn.itedus.lottery.domain.activity.service.partake;

import cn.itedus.lottery.domain.activity.model.req.PartakeReq;
import cn.itedus.lottery.domain.activity.model.res.PartakeResult;
import cn.itedus.lottery.domain.activity.model.vo.ActivityBillVO;
import cn.itedus.lottery.domain.activity.repository.IActivityRepository;

import javax.annotation.Resource;

public class ActivityPartakeSupport {

    @Resource
    protected IActivityRepository activityRepository;

    /**
     * æŸ¥è¯¢æ´»åŠ¨è´¦å•ä¿¡æ¯ åº“å­˜ çŠ¶æ€ æ—¥æœŸ ä¸ªäººå‚ä¸æ¬¡æ•°
     * @param req
     * @return
     */
    protected ActivityBillVO queryActivityBill(PartakeReq req){
        return activityRepository.queryActivityBill(req);
    }
}


```


* ActivityPartakeImpl
```java
package cn.itedus.lottery.domain.activity.service.partake.impl;

import cn.bugstack.middleware.db.router.strategy.IDBRouterStrategy;
import cn.itedus.lottery.common.Constants;
import cn.itedus.lottery.common.Result;
import cn.itedus.lottery.domain.activity.model.req.PartakeReq;
import cn.itedus.lottery.domain.activity.model.vo.ActivityBillVO;
import cn.itedus.lottery.domain.activity.repository.IUserTakeActivityRepository;
import cn.itedus.lottery.domain.activity.service.partake.BaseActivityPartake;
import cn.itedus.lottery.domain.support.IIdGenerator;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.dao.DuplicateKeyException;
import org.springframework.stereotype.Service;
import org.springframework.transaction.support.TransactionTemplate;

import javax.annotation.Resource;
import java.util.Map;


/**
 * æ´»åŠ¨å‚ä¸åŠŸèƒ½å®ç°
 */
@Service
public class ActivityPartakeImpl extends BaseActivityPartake {

    private Logger logger = LoggerFactory.getLogger(ActivityPartakeImpl.class);

    @Resource
    private IUserTakeActivityRepository userTakeActivityRepository;

    @Resource
    private Map<Constants.Ids, IIdGenerator> idGeneratorMap;

    @Resource
    private TransactionTemplate transactionTemplate;

    @Resource
    private IDBRouterStrategy dbRouter;

    @Override
    protected Result checkActivityBill(PartakeReq partake, ActivityBillVO bill) {

        // æ ¡éªŒï¼šæ´»åŠ¨çŠ¶æ€
        if (!Constants.ActivityState.DOING.getCode().equals(bill.getState())) {
            logger.warn("æ´»åŠ¨å½“å‰çŠ¶æ€éå¯ç”¨ stateï¼š{}", bill.getState());
            return Result.buildResult(Constants.ResponseCode.UN_ERROR, "æ´»åŠ¨å½“å‰çŠ¶æ€éå¯ç”¨");
        }

        // æ ¡éªŒï¼šæ´»åŠ¨æ—¥æœŸ
        if (bill.getBeginDateTime().after(partake.getPartakeDate()) || bill.getEndDateTime().before(partake.getPartakeDate())) {
            logger.warn("æ´»åŠ¨æ—¶é—´èŒƒå›´éå¯ç”¨ beginDateTimeï¼š{} endDateTimeï¼š{}", bill.getBeginDateTime(), bill.getEndDateTime());
            return Result.buildResult(Constants.ResponseCode.UN_ERROR, "æ´»åŠ¨æ—¶é—´èŒƒå›´éå¯ç”¨");
        }

        // æ ¡éªŒæ´»åŠ¨åº“å­˜
        if(bill.getStockSurplusCount() <= 0){
            logger.warn("æ´»åŠ¨å‰©ä½™åº“å­˜ä¸å¯ç”¨ :{}",bill.getStockSurplusCount());
            return Result.buildResult(Constants.ResponseCode.UN_ERROR,"æ´»åŠ¨å‰©ä½™åº“å­˜ä¸å¯ç”¨");
        }

        // æ ¡éªŒä¸ªäººåº“å­˜ - ä¸ªäººæ´»åŠ¨å‰©ä½™å¯ä»¥é¢†å–æ¬¡æ•° = è¡¨ç¤ºå·²ç»é¢†å–çš„æ¬¡æ•°
        if(bill.getUserTakeLeftCount() <= 0){
            logger.warn("ä¸ªäººé¢†å–æ¬¡æ•°ä¸å¯ç”¨:{}",bill.getUserTakeLeftCount());
            return Result.buildResult(Constants.ResponseCode.UN_ERROR,"æ´»åŠ¨å‰©ä½™åº“å­˜ä¸å¯ç”¨");
        }

        return Result.buildSuccessResult();
    }

    @Override
    protected Result subtractionActivityStock(PartakeReq req) {
        int count = activityRepository.subtractionActivityStock(req.getActivityId());
        if(0 == count){
            logger.error("æ‰£å‡æ´»åŠ¨åº“å­˜å¤±è´¥ activityId:{}",req.getActivityId());
            return Result.buildResult(Constants.ResponseCode.NO_UPDATE);
        }
        return Result.buildSuccessResult();
    }

    /**
     * é¢†å–æ´»åŠ¨æ“ä½œ  ä¹Ÿå°±æ˜¯å…ˆæ‰£å‡ä¸ªäºº
     * @param partake
     * @param bill  æ´»åŠ¨æµæ°´è´¦å•
     * @return
     */
    @Override
    protected Result grabActivity(PartakeReq partake, ActivityBillVO bill) {
        try{
            // ç¼–ç¨‹å¼ åˆ†åº“åˆ†è¡¨  åœ¨ä¸šåŠ¡é€»è¾‘ä¸­æ˜¾ç¤ºè°ƒç”¨è·¯ç”±æ–¹æ³•  åŠ¨æ€æ ¹æ®è¿è¡Œå‚æ•°æ¯”å¦‚ç”¨æˆ·id å†³å®šç›®æ ‡æ•°æ®åº“
            // å¦ä¸€ç§åŸºäºæ³¨è§£çš„åˆ†åº“åˆ†è¡¨  ç›´æ¥ä½¿ç”¨åœ¨DAOå±‚çš„æ–¹æ³•ä¸Š
            dbRouter.doRouter(partake.getuId());

            // ç¼–ç¨‹äº‹åŠ¡ç®¡ç†çš„ä¾‹å­  å…è®¸åœ¨åŒ¿åå‡½æ•°æˆ–è€…Lambdaè¡¨è¾¾å¼ç§æ‰§è¡Œä¸€ä¸ªäº‹åŠ¡ä»£ç å—
            return transactionTemplate.execute(status ->{
                try{
                    // æ‰£å‡ä¸ªäººå·²ç»å‚ä¸æ¬¡æ•°
                    int updateCount = userTakeActivityRepository.subtractionLeftCount(bill.getActivityId(),bill.getActivityName(),bill.getTakeCount(), bill.getUserTakeLeftCount(), partake.getuId(), partake.getPartakeDate());
                    if(0 == updateCount){
                        // æ›´æ–°å¤±è´¥
                        status.setRollbackOnly();
                        logger.error("é¢†å–æ´»åŠ¨ï¼Œæ‰£å‡ä¸ªäººå·²ç»å‚ä¸æ¬¡æ•°å¤±è´¥ activityId:{} uId{}",partake.getActivityId(),partake.getuId());

                        return Result.buildResult(Constants.ResponseCode.NO_UPDATE);
                    }

                    // æ’å…¥é¢†å–æ´»åŠ¨ä¿¡æ¯  å¦‚æœæ‰£å‡æˆåŠŸ é‚£ä¹ˆç”Ÿæˆä¸€ä¸ªæ–°çš„å”¯ä¸€ID ä½¿ç”¨é›ªèŠ±ç®—æ³•ç”Ÿæˆ
                    Long takeId = idGeneratorMap.get(Constants.Ids.SnowFlake).nextId();

                    // æ’å…¥æ´»åŠ¨ä¿¡æ¯åˆ°æ•°æ®åº“ä¸­
                    userTakeActivityRepository.takeActivity(bill.getActivityId(),bill.getActivityName(),bill.getTakeCount(),bill.getUserTakeLeftCount(), partake.getuId(), partake.getPartakeDate(), takeId);

                }catch (DuplicateKeyException e){
                    status.setRollbackOnly();
                    logger.error("é¢†å–æ´»åŠ¨ å”¯ä¸€ç´¢å¼•å†²çª activityId:{} uId:{}",partake.getActivityId(),partake.getuId());
                    return Result.buildResult(Constants.ResponseCode.NO_UPDATE);
                }

                return Result.buildSuccessResult();
            });

        }finally {
            dbRouter.clear();
        }
    }
}


```



### æ€»ç»“ä¸€ä¸‹æ¨¡æ¿æ¨¡å¼è¿›è¡ŒæŠ½å¥–æ´»åŠ¨


åœ¨æŠ½å¥–ç³»ç»Ÿçš„è®¾è®¡ä¸­ï¼Œä½¿ç”¨æ¨¡æ¿æ–¹æ³•æ¨¡å¼å¯ä»¥éå¸¸æœ‰æ•ˆåœ°ç»Ÿä¸€æ´»åŠ¨å‚ä¸çš„æµç¨‹ï¼ŒåŒæ—¶æä¾›è¶³å¤Ÿçš„çµæ´»æ€§æ¥åº”å¯¹ä¸åŒç±»å‹çš„æ´»åŠ¨æˆ–æŠ½å¥–ç­–ç•¥ã€‚


* å®šä¹‰æŠ½è±¡åŸºç±»: å®šä¹‰ä¸€ä¸ªæŠ½è±¡åŸºç±»ï¼ˆå¦‚BaseActivityPartakeï¼‰ï¼Œåœ¨å…¶ä¸­å®šä¹‰æŠ½å¥–æ´»åŠ¨å‚ä¸çš„åŸºæœ¬æ­¥éª¤å’Œæµç¨‹çš„æ¡†æ¶ï¼ˆå³æ¨¡æ¿æ–¹æ³•ï¼‰ã€‚è¿™ä¸ªæ¨¡æ¿æ–¹æ³•ä¼šå®šä¹‰æ‰§è¡Œçš„é¡ºåºå’ŒåŸºæœ¬çš„è¡Œä¸ºï¼Œä½†ä¸å®ç°å…·ä½“çš„æ“ä½œç»†èŠ‚

```java
public abstract class BaseActivityPartake {

    // æ¨¡æ¿æ–¹æ³•ï¼Œå®šä¹‰äº†å‚ä¸æ´»åŠ¨çš„æ­¥éª¤
    public final PartakeResult doPartake(PartakeReq req) {
        ActivityBillVO activityBill = queryActivityBill(req);
        if (!checkActivityEligibility(activityBill)) {
            return new PartakeResult("Activity Ineligible");
        }
        if (!deductStock(activityBill)) {
            return new PartakeResult("Stock Insufficient");
        }
        return executePartake(req, activityBill);
    }

    // æŸ¥è¯¢æ´»åŠ¨è¯¦æƒ…ï¼ˆå…·ä½“å®ç°å¯èƒ½å› æ´»åŠ¨ä¸åŒè€Œä¸åŒï¼‰
    protected abstract ActivityBillVO queryActivityBill(PartakeReq req);

    // æ£€æŸ¥æ´»åŠ¨èµ„æ ¼
    protected abstract boolean checkActivityEligibility(ActivityBillVO bill);

    // æ‰£å‡åº“å­˜
    protected abstract boolean deductStock(ActivityBillVO bill);

    // æ‰§è¡Œå‚ä¸æ´»åŠ¨çš„å…·ä½“æ“ä½œ
    protected abstract PartakeResult executePartake(PartakeReq req, ActivityBillVO bill);
}


```

* å®ç°å…·ä½“å­ç±»:é’ˆå¯¹ä¸åŒç±»å‹çš„æ´»åŠ¨ï¼Œå¯ä»¥å®ç°ä¸Šè¿°æŠ½è±¡åŸºç±»çš„å¤šä¸ªå­ç±»ã€‚è¿™äº›å­ç±»å°†å…·ä½“å®ç°æŠ½è±¡åŸºç±»ä¸­å®šä¹‰çš„æŠ½è±¡æ–¹æ³•ï¼Œä»¥æ»¡è¶³ä¸åŒæ´»åŠ¨çš„ç‰¹å®šéœ€æ±‚
```java
public class LotteryPartake extends BaseActivityPartake {

    @Override
    protected ActivityBillVO queryActivityBill(PartakeReq req) {
        // å®ç°æŸ¥è¯¢æ´»åŠ¨è¯¦æƒ…çš„é€»è¾‘
    }

    @Override
    protected boolean checkActivityEligibility(ActivityBillVO bill) {
        // å®ç°æ£€æŸ¥æ´»åŠ¨èµ„æ ¼çš„é€»è¾‘
    }

    @Override
    protected boolean deductStock(ActivityBillVO bill) {
        // å®ç°æ‰£å‡åº“å­˜çš„é€»è¾‘
    }

    @Override
    protected PartakeResult executePartake(PartakeReq req, ActivityBillVO bill) {
        // å®ç°å…·ä½“çš„æŠ½å¥–é€»è¾‘
    }
}


```

**ä½¿ç”¨æ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„å¥½å¤„æ˜¯ï¼Œå®ƒæä¾›äº†ä¸€ç§å¾ˆå¥½çš„æ–¹å¼æ¥å¤ç”¨ä»£ç ï¼ˆæ´»åŠ¨å‚ä¸çš„å…±é€šæµç¨‹ï¼‰ï¼ŒåŒæ—¶è¿˜ä¿ç•™äº†è¶³å¤Ÿçš„çµæ´»æ€§æ¥åº”å¯¹ä¸åŒæ´»åŠ¨çš„ç‰¹æ®Šéœ€æ±‚ã€‚å­ç±»åªéœ€å®ç°é‚£äº›åœ¨ä¸åŒæ´»åŠ¨ä¸­æœ‰æ‰€ä¸åŒçš„æ­¥éª¤å³å¯**



## åœ¨åº”ç”¨å±‚ç¼–æ’æŠ½å¥–è¿‡ç¨‹


**æ€»çš„æµç¨‹ï¼šé¦–å…ˆæ˜¯å¦å­˜åœ¨æ²¡æœ‰æ‰§è¡Œçš„æŠ½å¥–å•å·ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œé¢†å–æ´»åŠ¨ï¼Œæ´»åŠ¨æ ¡éªŒï¼Œæ—¥æœŸæ ¡éªŒï¼Œåº“å­˜æ ¡éªŒï¼Œå‚ä¸æ¬¡æ•°æ ¡éªŒï¼Œé¢†å–æ´»åŠ¨å®Œæˆï¼Œæœ€åè·å–æŠ½å¥–å•å·ä¿¡æ¯ï¼Œæ¥ç€å‚ä¸æŠ½å¥–ï¼ŒæŠ½å¥–ç­–ç•¥ï¼Œå•é¡¹æ¦‚ç‡ï¼Œæ€»ä½“æ¦‚ç‡ï¼Œæ‰§è¡ŒæŠ½å¥–ï¼ŒæŠ½å¥–ç»“æœçš„å¥–å“IDå¾—åˆ°ï¼Œå¥–å“è½åº“ï¼Œå‘é€MQæ¶ˆæ¯ï¼Œè§¦å‘å¥–å“å‘è´§ï¼Œæ›´æ–°å‘è´§çŠ¶æ€**


* æ´»åŠ¨é¢†åŸŸä¸­æŸ¥è¯¢æ˜¯å¦å­˜åœ¨æ²¡æœ‰æ‰§è¡ŒæŠ½å¥–é¢†å–æ´»åŠ¨å•å·ï¼Œåœ¨SQLæŸ¥è¯¢å½“å‰æ´»åŠ¨IDï¼Œç”¨æˆ·æœ€æ—©é¢†å–ä½†æ˜¯æ²¡æœ‰æ¶ˆè´¹çš„ä¸€æ¡è®°å½•ï¼ˆè¿™éƒ¨åˆ†ä¸€èˆ¬æœ‰ä¸šåŠ¡æµç¨‹é™åˆ¶ï¼Œæ¯”å¦‚æ˜¯å¦å¤„ç†æœ€å…ˆè¿˜æ˜¯æœ€æ–°é¢†å–å•ï¼Œè¦æ ¹æ®è‡ªå·±çš„ä¸šåŠ¡å®é™…åœºæ™¯è¿›è¡Œå¤„ç†ï¼‰


* application åº”ç”¨å±‚è°ƒç”¨é¢†åŸŸæœåŠ¡åŠŸèƒ½ï¼Œç¼–æ’æŠ½å¥–è¿‡ç¨‹ï¼ŒåŒ…æ‹¬ï¼šé¢†å–æ´»åŠ¨  æ‰§è¡ŒæŠ½å¥– è½åº“ç»“æœ  

![å›¾ 0](../images/dde9428279ca09451f829714110bf65a9f199b1e82651417edf9fc657bf322b5.png)  


* æŠ½å¥–æ•´ä¸ªæ´»åŠ¨è¿‡ç¨‹çš„æµç¨‹ç¼–æ’ï¼Œä¸»è¦åŒ…æ‹¬ï¼šå¯¹æ´»åŠ¨çš„é¢†å–ï¼Œå¯¹æŠ½å¥–çš„æ“ä½œï¼Œå¯¹ä¸­å¥–ç»“æœçš„å­˜æ”¾ ä»¥åŠå¦‚ä½•å¤„ç†å‘å¥–ï¼Œå¯¹äºå‘å¥–çš„æµç¨‹ æˆ‘ä»¬ä½¿ç”¨MQè§¦å‘
* å¯¹äºæ¯ä¸€ä¸ªæµç¨‹èŠ‚ç‚¹ç¼–æ’çš„å†…å®¹ï¼Œéƒ½æ˜¯åœ¨é¢†åŸŸå±‚å¼€å‘å®Œæˆçš„ï¼Œè€Œåº”ç”¨å±‚åªæ˜¯ä½œä¸ºæœ€ç®€å•çš„ä¸€å±‚ï¼Œæ–¹ä¾¿æµç¨‹ç¼–æ’ï¼Œç”Ÿæˆä»£ç 



## æ‰§è¡ŒæŠ½å¥–ç®—æ³•å…¨æµç¨‹

* è·å–æŠ½å¥–ç­–ç•¥
* æ ¡éªŒæŠ½å¥–ç­–ç•¥æ˜¯å¦ä»¥åŠåˆå§‹åŒ–åˆ°å†…å­˜
* è·å–ä¸åœ¨æŠ½å¥–èŒƒå›´å†…çš„åˆ—è¡¨ åŒ…æ‹¬ï¼šå¥–å“åº“å­˜ä¸ºç©ºï¼Œé£æ§ç­–ç•¥ 
* æ‰§è¡ŒæŠ½å¥–ç®—æ³•
* åŒ…è£…ä¸­å¥–ç»“æœ



```java
    public DrawResult doDrawExec(DrawReq req) {
        // 1. è·å–æŠ½å¥–ç­–ç•¥
        StrategyRich strategyRich = super.queryStrategyRich(req.getStrategyId());
        StrategyBriefVO strategy = strategyRich.getStrategy();

        // 2. æ ¡éªŒæŠ½å¥–ç­–ç•¥æ˜¯å¦å·²ç»åˆå§‹åŒ–åˆ°å†…å­˜
        this.checkAndInitRateData(req.getStrategyId(), strategy.getStrategyMode(), strategyRich.getStrategyDetailList());

        // 3. è·å–ä¸åœ¨æŠ½å¥–èŒƒå›´å†…çš„åˆ—è¡¨ï¼ŒåŒ…æ‹¬ï¼šå¥–å“åº“å­˜ä¸ºç©ºã€é£æ§ç­–ç•¥ã€ä¸´æ—¶è°ƒæ•´ç­‰
        List<String> excludeAwardIds = this.queryExcludeAwardIds(req.getStrategyId());

        // 4. æ‰§è¡ŒæŠ½å¥–ç®—æ³•
        String awardId = this.drawAlgorithm(req.getStrategyId(), drawAlgorithmGroup.get(strategy.getStrategyMode()), excludeAwardIds);

        // 5. åŒ…è£…ä¸­å¥–ç»“æœ
        return buildDrawResult(req.getuId(), req.getStrategyId(), awardId, strategy);
    }

```


## è§„åˆ™é‡åŒ–å¼•æ“å‚ä¸æ´»åŠ¨

* è§„åˆ™å¼•æ“å¼€å‘éœ€è¦çš„ç›¸å…³çš„é…ç½®ç±»è¡¨ï¼šrule_tree rule_tree_node rule_tree_node_line
* è¿ç”¨ç»„åˆæ¨¡å¼æ­å»ºè§„åˆ™å¼•æ“é¢†åŸŸæœåŠ¡ï¼ŒåŒ…æ‹¬ï¼šlogicé€»è¾‘è¿‡æ»¤å™¨ï¼Œengineå¼•æ“æ‰§è¡Œå™¨
* ç»„åˆæ¨¡å¼çš„ç‰¹ç‚¹å°±åƒæ˜¯æ­å»ºå‡ºä¸€æ£µäºŒå‰æ ‘ï¼Œè€Œåº“è¡¨ä¸­åˆ™éœ€è¦æŠŠè¿™æ ·ä¸€é¢—äºŒå‰æ ‘å­˜æ”¾è¿›å»ï¼Œé‚£ä¹ˆè¿™é‡Œå°±éœ€è¦åŒ…æ‹¬ï¼šæ ‘æ ¹ã€æ ‘èŒã€å­å¶ã€æœå®ã€‚åœ¨å…·ä½“çš„é€»è¾‘å®ç°ä¸­åˆ™éœ€è¦é€šè¿‡å­å¶åˆ¤æ–­èµ°å“ªä¸ªæ ‘èŒä»¥åŠæœ€ç»ˆç­›é€‰å‡ºä¸€ä¸ªæœå®æ¥


![å›¾ 1](../images/268eb3ac20a385f0ed640de50530beeb498aad929d803ca61fd64c153a06eccb.png)  

* åŸºäºé‡åŒ–å†³ç­–å¼•æ“ï¼Œç­›é€‰ç”¨æˆ·èº«ä»½æ ‡ç­¾ï¼Œæ‰¾åˆ°ä¸€ä¸ªç¬¦åˆå‚ä¸çš„æ´»åŠ¨å·ï¼Œæ‹¿åˆ°æ´»åŠ¨å¥½ä¹‹å å°±å¯ä»¥å‚ä¸åˆ°å…·ä½“çš„æŠ½å¥–æ´»åŠ¨ä¸­
* é€šå¸¸é‡åŒ–å†³ç­–å¼•æ“ä¹Ÿæ˜¯ä¸€ç§ç”¨äºå·®å¼‚åŒ–äººç¾¤çš„è§„åˆ™è¿‡æ»¤å™¨ï¼Œä¸åªæ˜¯å¯ä»¥è¿‡æ»¤å‡ºæ´»åŠ¨ï¼Œä¹Ÿå¯ä»¥ç”¨äºæ´»åŠ¨å”¯ç‹¬çš„è¿‡æ»¤ï¼Œåˆ¤æ–­æ˜¯å¦å¯ä»¥å‚ä¸åˆ°è¿™ä¸ªæŠ½å¥–æ´»åŠ¨ä¸­
* åœ¨åº”ç”¨å±‚åº§ä¸€å±‚å°è£…ï¼Œç”±æ¥å£å±‚è¿›è¡Œè°ƒç”¨ä½¿ç”¨ï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·å‚ä¸æ´»åŠ¨ä¹‹å‰ï¼Œè¦åšä¸€å±‚è§„åˆ™å¼•æ“è¿‡æ»¤


### ä½ çš„è§„åˆ™é‡åŒ–å¼•æ“å…·ä½“å¼æ€ä¹ˆå®ç°çš„


* é¦–å…ˆè·å–ä¸å†³ç­–ç‰©æ–™ç›¸å…³çš„è§„åˆ™æ ‘ä¿¡æ¯ï¼Œå¦‚æœä¸ºç©º æŠ›å‡ºå¼‚å¸¸ è¡¨ç¤ºæ— æ³•è¿›è¡Œå†³ç­–
* ä½¿ç”¨å†³ç­–æ ‘çš„é…ç½®ä¿¡æ¯å’Œå†³ç­–ç‰©æ–™æ¥å†³å®šåº”å½“èµ°å‘çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
     * 1 è·å–è§„åˆ™ä¹¦çš„æ ¹èŠ‚ç‚¹ä¿¡æ¯ è¿™æ˜¯å†³ç­–çš„èµ·ç‚¹
     * 2 éå†è§„åˆ™æ ‘ ä½¿ç”¨å¾ªç¯æ¥éå†è§„åˆ™æ ‘çš„èŠ‚ç‚¹  å¯¹äºæ¯ä¸€ä¸ªèŠ‚ç‚¹  ä½¿ç”¨ä¸è¯¥èŠ‚ç‚¹ç›¸å…³è”çš„è§„åˆ™ket ä»Mapä¸­è·å–ç›¸åº”çš„è·¯åŸºè¿‡æ»¤å™¨
     * 3 æ‰§è¡Œå†³ç­–é€»è¾‘  é€šè¿‡é€»è¾‘è¿‡æ»¤å™¨è·å–å†³ç­–ä¹‹ æ ¹æ®è¿™ä¸ªå€¼å’ŒèŠ‚ç‚¹çš„è¿æ¥çº¿å†³å®šä¸‹ä¸€ä¸ªèŠ‚ç‚¹

* lottery-application åº”ç”¨å±‚å¯¹è§„åˆ™å¼•æ“çš„è°ƒç”¨
  * è¾“å…¥å‚æ•°ä¸º QuantificationDrawReqï¼ŒåŒ…å«ç”¨æˆ·IDã€è§„åˆ™æ ‘IDå’Œä¸€ç»„å†³ç­–å€¼ã€‚
  * æ‰§è¡Œè§„åˆ™å¼•æ“ï¼Œè·å–ç”¨æˆ·å¯ä»¥å‚ä¸çš„æ´»åŠ¨å·
  * ç„¶åè¿›è¡ŒæŠ½å¥–å¤„ç†ï¼Œå¹¶å°†ç»“æœè½¬æ¢å’Œå°è£…ï¼Œè¿”å›ç»™è°ƒç”¨è€…


![å›¾ 3](../images/539e04170400cf4ce1da1b7c843fbab5e3873f8118f7b18ffea3c6858c5db7ac.png)  


## MQæ¶ˆæ¯ç»„ä»¶è§£è€¦å¦‚ä½•å®ç°çš„

* æ­å»ºMQæ¶ˆæ¯ç»„ä»¶KafkaæœåŠ¡ç¯å¢ƒï¼Œå¹¶æ•´åˆåˆ°SpringBootä¸­ï¼Œå®Œæˆæ¶ˆæ¯çš„ç”Ÿäº§å’Œæ¶ˆè´¹å¤„ç†

### Kafka
*  Kafkaé€‚åˆç¦»çº¿å’Œåœ¨çº¿æ¶ˆæ¯æ¶ˆè´¹ã€‚ Kafkaæ¶ˆæ¯ä¿ç•™åœ¨ç£ç›˜ä¸Šï¼Œå¹¶åœ¨ç¾¤é›†å†…å¤åˆ¶ä»¥é˜²æ­¢æ•°æ®ä¸¢å¤±ã€‚ Kafkaæ„å»ºåœ¨ZooKeeperåŒæ­¥æœåŠ¡ä¹‹ä¸Šã€‚ å®ƒä¸Apache Stormå’ŒSparkéå¸¸å¥½åœ°é›†æˆï¼Œç”¨äºå®æ—¶æµå¼æ•°æ®åˆ†æã€‚
*  å¯é æ€§ - Kafkaæ˜¯åˆ†å¸ƒå¼ï¼Œåˆ†åŒºï¼Œå¤åˆ¶å’Œå®¹é”™çš„ã€‚

* å¯æ‰©å±•æ€§ - Kafkaæ¶ˆæ¯ä¼ é€’ç³»ç»Ÿè½»æ¾ç¼©æ”¾ï¼Œæ— éœ€åœæœºã€‚

* è€ç”¨æ€§ - Kafkaä½¿ç”¨åˆ†å¸ƒå¼æäº¤æ—¥å¿—ï¼Œè¿™æ„å‘³ç€æ¶ˆæ¯ä¼šå°½å¯èƒ½å¿«åœ°ä¿ç•™åœ¨ç£ç›˜ä¸Šï¼Œå› æ­¤å®ƒæ˜¯æŒä¹…çš„ã€‚

* æ€§èƒ½ - Kafkaå¯¹äºå‘å¸ƒå’Œè®¢é˜…æ¶ˆæ¯éƒ½å…·æœ‰é«˜ååé‡ã€‚ å³ä½¿å­˜å‚¨äº†è®¸å¤šTBçš„æ¶ˆæ¯ï¼Œå®ƒä¹Ÿä¿æŒç¨³å®šçš„æ€§èƒ½


### å®ç°


* ä½¿ç”¨MQæ¶ˆæ¯çš„ç‰¹æ€§ï¼ŒæŠŠç”¨æˆ·æŠ½å¥–åˆ°å‘è´§åˆ°æµç¨‹è¿›è¡Œè§£è€¦ï¼Œè¿™ä¸ªè¿‡ç¨‹åŒ…æ‹¬äº†æ¶ˆæ¯çš„å‘é€ã€åº“è¡¨ä¸­çŠ¶æ€çš„æ›´æ–°ï¼Œæ¶ˆæ¯çš„æ¥å—æ¶ˆè´¹ï¼Œå‘å°†çŠ¶æ€çš„å¤„ç†ç­‰
* åœ¨æ•°æ®åº“è¡¨ user_strategy_export æ·»åŠ å­—æ®µ mq_state è¿™ä¸ªå­—æ®µç”¨äºå‘é€ MQ æˆåŠŸæ›´æ–°åº“è¡¨çŠ¶æ€ï¼Œå¦‚æœ MQ æ¶ˆæ¯å‘é€å¤±è´¥åˆ™éœ€è¦é€šè¿‡å®šæ—¶ä»»åŠ¡è¡¥å¿ MQ æ¶ˆæ¯
* å¯åŠ¨ kafka æ–°å¢ topicï¼šlottery_invoice ç”¨äºå‘è´§å•æ¶ˆæ¯ï¼Œå½“æŠ½å¥–å®Œæˆååˆ™å‘é€ä¸€ä¸ªå‘è´§å•ï¼Œå†å¼‚æ­¥å¤„ç†å‘è´§æµç¨‹ï¼Œè¿™ä¸ªéƒ¨åˆ†å°±æ˜¯MQçš„è§£è€¦æµç¨‹ä½¿ç”¨

![å›¾ 4](../images/900832db68ac5bcb56ff074da6436dd78fb8f7845090e8cc58d4f0a0cbd0f0b2.png)  


* ä»ç”¨æˆ·å‘èµ·æŠ½å¥–åˆ°ä¸­å¥–ä¹‹åå¼€å§‹ï¼Œå°±æ˜¯MQå¤„ç†å‘å¥–çš„è¿‡ç¨‹
* å› ä¸ºMQæ¶ˆæ¯çš„å‘é€æ˜¯ä¸å…·å¤‡äº‹åŠ¡æ€§çš„ï¼Œæ‰€ä»¥å°±æ˜¯ä½ å‘é€MQçš„æ—¶å€™ä¼šå¤±è´¥ï¼Œé‚£ä¹ˆMQå‘é€å®Œæˆä¹‹åéœ€è¦çŸ¥é“æ˜¯å¦å‘é€æˆåŠŸï¼Œè¿›è¡Œåº“è¡¨çŠ¶æ€æ›´æ–°ï¼Œå¦‚æœå‘é€å¤±è´¥éœ€è¦ä½¿ç”¨workeræ¥è¡¥å¿MQå‘é€
* æœ€åMQå‘é€å®Œæˆåˆ°æ¶ˆè´¹ï¼Œä¹Ÿæ˜¯å¯èƒ½æœ‰å¤±è´¥çš„ï¼Œæ¯”å¦‚å¤„ç†å¤±è´¥ï¼Œæ›´æ–°åº“è¡¨å¤±è´¥ç­‰ï¼Œä½†æ˜¯æ— è®ºæ˜¯ä»€ä¹ˆå¤±è´¥éƒ½æ˜¯éœ€è¦ä¿è¯MQè¿›è¡Œé‡è¯•å¤„ç†ï¼Œè€Œä¿è¯MQæ¶ˆæ¯é‡è¯•çš„å‰æå°±æ˜¯æœåŠ¡çš„å¹‚ç­‰æ€§ï¼Œå¦åˆ™ä½ åœ¨é‡è¯•çš„è¿‡ç¨‹ä¸­å°±é€ æˆäº†æµç¨‹ä¸€åœº æ¯”å¦‚æ›´æ–°æ¬¡æ•°å¤šäº† æ•°æ®åº“æ’å…¥å¤šäº† å‘å¥–å¤šæ¬¡
* 

```java
Component
public class KafkaProducer {

    private Logger logger = LoggerFactory.getLogger(KafkaProducer.class);

    @Resource
    private KafkaTemplate<String, Object> kafkaTemplate;

    /**
     * MQä¸»é¢˜ï¼šä¸­å¥–å‘è´§å•
     */
    public static final String TOPIC_INVOICE = "lottery_invoice";

    /**
     * å‘é€ä¸­å¥–ç‰©å“å‘è´§å•æ¶ˆæ¯
     *
     * @param invoice å‘è´§å•
     */
    public ListenableFuture<SendResult<String, Object>> sendLotteryInvoice(InvoiceVO invoice) {
        String objJson = JSON.toJSONString(invoice);
        logger.info("å‘é€MQæ¶ˆæ¯ topicï¼š{} bizIdï¼š{} messageï¼š{}", TOPIC_INVOICE, invoice.getuId(), objJson);
        return kafkaTemplate.send(TOPIC_INVOICE, objJson);
    }

}


```

* æˆ‘ä»¬ä¼šæŠŠæ‰€æœ‰çš„ç”Ÿäº§æ¶ˆæ¯éƒ½æ”¾åˆ° KafkaProducer ä¸­ï¼Œå¹¶å¯¹å¤–æä¾›ä¸€ä¸ªå¯ä»¥å‘é€ MQ æ¶ˆæ¯çš„æ–¹æ³•ã€‚
* å› ä¸ºæˆ‘ä»¬é…ç½®çš„ç±»å‹è½¬æ¢ä¸º StringDeserializer æ‰€ä»¥å‘é€æ¶ˆæ¯çš„æ–¹å¼æ˜¯ JSON å­—ç¬¦ä¸²ï¼Œå½“ç„¶è¿™ä¸ªç¼–è§£ç å™¨æ˜¯å¯ä»¥é‡å†™çš„ï¼Œæ»¡è¶³ä½ å‘é€å…¶ä»–ç±»å‹çš„æ•°æ®
* sendLotteryInvoiceï¼šå‘é€ä¸­å¥–ç‰©å“å‘è´§å•æ¶ˆæ¯åˆ° Kafkaã€‚
* å‚æ•°ä¸º InvoiceVO å¯¹è±¡ï¼ŒåŒ…å«å‘è´§å•çš„è¯¦ç»†ä¿¡æ¯ã€‚
* æ–¹æ³•é¦–å…ˆå°† InvoiceVO å¯¹è±¡è½¬æ¢ä¸º JSON å­—ç¬¦ä¸²ã€‚
* ä½¿ç”¨ kafkaTemplate.send æ–¹æ³•å‘é€æ¶ˆæ¯åˆ° "lottery_invoice" ä¸»é¢˜ï¼Œå¹¶è¿”å› ListenableFuture<SendResult<String, Object>> å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å¯ä»¥ç”¨æ¥å¤„ç†å¼‚æ­¥å‘é€ç»“æœ
* å½“ç”¨æˆ·ä¸­å¥–éœ€è¦å‘è´§æ—¶ï¼Œç³»ç»Ÿä¼šåˆ›å»ºä¸€ä¸ªå‘è´§å•ä¿¡æ¯çš„ InvoiceVO å¯¹è±¡ï¼Œå¹¶é€šè¿‡è¿™ä¸ªç±»å‘é€åˆ° Kafkaã€‚æ¶ˆè´¹è€…ï¼ˆå¯èƒ½æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªæœåŠ¡ï¼‰è®¢é˜…è¿™ä¸ªä¸»é¢˜ï¼Œæ¥æ”¶åˆ°æ¶ˆæ¯åè¿›è¡Œç›¸åº”çš„å¤„ç†ï¼Œæ¯”å¦‚ç”Ÿæˆå‘è´§è®¢å•ï¼Œé€šçŸ¥ä»“åº“ç³»ç»Ÿç­‰ã€‚

```java
@Component
public class LotteryInvoiceListener {

    private Logger logger = LoggerFactory.getLogger(LotteryInvoiceListener.class);

    @Resource
    private DistributionGoodsFactory distributionGoodsFactory;

    @KafkaListener(topics = "lottery_invoice", groupId = "lottery")
    public void onMessage(ConsumerRecord<?, ?> record, Acknowledgment ack, @Header(KafkaHeaders.RECEIVED_TOPIC) String topic) {
        Optional<?> message = Optional.ofNullable(record.value());

        // 1. åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦å­˜åœ¨
        if (!message.isPresent()) {
            return;
        }

        // 2. å¤„ç† MQ æ¶ˆæ¯
        try {
            // 1. è½¬åŒ–å¯¹è±¡ï¼ˆæˆ–è€…ä½ ä¹Ÿå¯ä»¥é‡å†™Serializer<T>ï¼‰
            InvoiceVO invoiceVO = JSON.parseObject((String) message.get(), InvoiceVO.class);

            // 2. è·å–å‘é€å¥–å“å·¥å‚ï¼Œæ‰§è¡Œå‘å¥–
            IDistributionGoods distributionGoodsService = distributionGoodsFactory.getDistributionGoodsService(invoiceVO.getAwardType());
            DistributionRes distributionRes = distributionGoodsService.doDistribution(new GoodsReq(invoiceVO.getuId(), invoiceVO.getOrderId(), invoiceVO.getAwardId(), invoiceVO.getAwardName(), invoiceVO.getAwardContent()));

            Assert.isTrue(Constants.AwardState.SUCCESS.getCode().equals(distributionRes.getCode()), distributionRes.getInfo());

            // 3. æ‰“å°æ—¥å¿—
            logger.info("æ¶ˆè´¹MQæ¶ˆæ¯ï¼Œå®Œæˆ topicï¼š{} bizIdï¼š{} å‘å¥–ç»“æœï¼š{}", topic, invoiceVO.getuId(), JSON.toJSONString(distributionRes));

            // 4. æ¶ˆæ¯æ¶ˆè´¹å®Œæˆ
            ack.acknowledge();
        } catch (Exception e) {
            // å‘å¥–ç¯èŠ‚å¤±è´¥ï¼Œæ¶ˆæ¯é‡è¯•ã€‚æ‰€æœ‰åˆ°ç¯èŠ‚ï¼Œå‘è´§ã€æ›´æ–°åº“ï¼Œéƒ½éœ€è¦ä¿è¯å¹‚ç­‰ã€‚
            logger.error("æ¶ˆè´¹MQæ¶ˆæ¯ï¼Œå¤±è´¥ topicï¼š{} messageï¼š{}", topic, message.get());
            throw e;
        }
    }

}


```


![å›¾ 5](../images/7df0a396ace8f755ca19b372ab8341e1b2003030281d72ec2ac8e939fa26c848.png)  

### MQè§£è€¦

### ç”Ÿäº§è€…
* æŠ½å¥–ç»“æœè½åº“ä¹‹å
* å‘é€MQ è§¦å‘å‘å¥–æµç¨‹
* è°ƒåŠ¨ kafkaProducer.sendLotteryInvoice å‘é€ä¸€ä¸ªä¸­å¥–ç»“æœçš„å‘è´§å•ã€‚
* æ¶ˆæ¯å‘é€å®Œæ¯•åè¿›è¡Œå›è°ƒå¤„ç†ï¼Œæ›´æ–°æ•°æ®åº“ä¸­ MQ å‘é€çš„çŠ¶æ€ï¼Œå¦‚æœæœ‰ MQ å‘é€å¤±è´¥åˆ™æ›´æ–°æ•°æ®åº“ mq_state = 2 è¿™é‡Œè¿˜æœ‰å¯èƒ½åœ¨æ›´æ–°åº“è¡¨çŠ¶æ€çš„æ—¶å€™å¤±è´¥ï¼Œä½†æ²¡å…³ç³»è¿™äº›éƒ½ä¼šè¢« worker è¡¥å¿å¤„ç†æ‰ï¼Œä¸€ç§æ˜¯å‘é€ MQ å¤±è´¥ï¼Œå¦å¤–ä¸€ç§æ˜¯ MQ çŠ¶æ€ä¸º 0 ä½†å¾ˆä¹…éƒ½æ²¡æœ‰å‘é€ MQ é‚£ä¹ˆä¹Ÿå¯ä»¥è§¦å‘å‘é€ã€‚
### æ¶ˆè´¹è€…-LotteryInvoiceListener

* è¿™ä¸ªç±»è´Ÿè´£ç›‘å¬å’Œå¤„ç†æ¥è‡ªKafkaä¸­åä¸º "lottery_invoice" çš„ä¸»é¢˜çš„æ¶ˆæ¯
* æ¶ˆæ¯å­˜åœ¨æ€§æ£€æŸ¥ï¼šä½¿ç”¨Optionalç±»æ¥åˆ¤æ–­æ¶ˆæ¯å†…å®¹æ˜¯å¦å­˜åœ¨
* å°†æ¶ˆæ¯å†…å®¹è½¬æ¢ä¸ºInvoiceVOå¯¹è±¡ï¼Œè¿™æ˜¯ä¸€ä¸ªåŒ…å«ä¸­å¥–ä¿¡æ¯çš„æ•°æ®å¯¹è±¡
* é€šè¿‡distributionGoodsFactoryè·å–å¯¹åº”çš„å‘å¥–æœåŠ¡ï¼ŒåŸºäºå¥–å“ç±»å‹
* è°ƒç”¨å‘å³å°†æœåŠ¡çš„doDistributionæ–¹æ³•è¿›è¡Œå¥–å“å®é™…å‘æ”¾
* ä½¿ç”¨Assertè¿›è¡Œç»“æœéªŒè¯ï¼Œç¡®ä¿å‘å¥–æˆåŠŸ



### ActivityProcessImpl#doDrawProcess 

* ç”¨æˆ·é¢†å–æ´»åŠ¨
* æ‰§è¡ŒæŠ½å¥–
* ç»“æœè½åº“
* å‘é€MQæ¶ˆæ¯ è§¦å‘å‘å¥–æµç¨‹
* MQæ¶ˆæ¯å‘é€æˆåŠŸï¼Œæ›´æ–°æ•°æ®åº“è¡¨ï¼Œæ›´æ–°æ•°æ®åº“è¡¨ user_strategy_export.mq_state = 1
* MQ æ¶ˆæ¯å‘é€å¤±è´¥ 2
* æ¶ˆæ¯å‘é€å®Œæ¯•åè¿›è¡Œå›è°ƒå¤„ç†ï¼Œæ›´æ–°æ•°æ®åº“ä¸­ MQ å‘é€çš„çŠ¶æ€ï¼Œå¦‚æœæœ‰ MQ å‘é€å¤±è´¥åˆ™æ›´æ–°æ•°æ®åº“ mq_state = 2 è¿™é‡Œè¿˜æœ‰å¯èƒ½åœ¨æ›´æ–°åº“è¡¨çŠ¶æ€çš„æ—¶å€™å¤±è´¥ï¼Œä½†æ²¡å…³ç³»è¿™äº›éƒ½ä¼šè¢« worker è¡¥å¿å¤„ç†æ‰ï¼Œä¸€ç§æ˜¯å‘é€ MQ å¤±è´¥ï¼Œå¦å¤–ä¸€ç§æ˜¯ MQ çŠ¶æ€ä¸º 0 ä½†å¾ˆä¹…éƒ½æ²¡æœ‰å‘é€ MQ é‚£ä¹ˆä¹Ÿå¯ä»¥è§¦å‘å‘é€
* å› ä¸ºç”¨æˆ·åªéœ€è¦çŸ¥é“è‡ªå·±ä¸­å¥–äº†ï¼Œä½†å‘å¥–åˆ°è´§æ˜¯å¯ä»¥ç­‰å¾…çš„ï¼Œæ¯•ç«Ÿå‘é€è™šæ‹Ÿå•†å“çš„ç­‰å¾…æ—¶é—´å¹¶ä¸ä¼šå¾ˆé•¿ï¼Œè€Œå®ç‰©å•†å“èµ°ç‰©æµå°±æ›´å¯ä»¥æ¥æ”¶äº†

## è½»é‡çº§åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦å¹³å°ï¼‰æ¥ç®¡ç†å’Œè°ƒåº¦æŠ½å¥–æ´»åŠ¨çš„çŠ¶æ€

* è·å–æ´»åŠ¨åˆ—è¡¨: ä»activityDeploy.scanToDoActivityList(0L)è·å–å½“å‰éœ€è¦å¤„ç†çš„æ´»åŠ¨åˆ—è¡¨ã€‚è¿™ä¸ªæ–¹æ³•ä¼¼ä¹é€šè¿‡ä¼ é€’æœ€åä¸€æ¡å¤„ç†çš„æ´»åŠ¨IDæ¥åˆ†é¡µè·å–æ•°æ®
* æ¡ä»¶åˆ¤æ–­: å¦‚æœè·å–çš„æ´»åŠ¨åˆ—è¡¨ä¸ºç©ºï¼Œåˆ™è®°å½•æ—¥å¿—å¹¶ç»“æŸæ‰§è¡Œ
* éå†æ´»åŠ¨åˆ—è¡¨ï¼šå¯¹æ´»åŠ¨çŠ¶æ€ä¸ºå®¡æ ¸é€šè¿‡ï¼ˆçŠ¶æ€ç ä¸º4ï¼‰ï¼Œä¸”ä¸´è¿‘å¼€å¯æ—¶é—´çš„æ—¶å€™ï¼Œå°†å…¶çŠ¶æ€è½¬å˜ä¸ºæ´»åŠ¨ä¸­
* çŠ¶æ€ä¸º4ï¼ˆå®¡æ ¸é€šè¿‡ï¼‰ï¼šå½“æ´»åŠ¨çŠ¶æ€ä¸ºå®¡æ ¸é€šè¿‡(çŠ¶æ€ç 4)ï¼Œä¸”ä¸´è¿‘å¼€å¯æ—¶é—´æ—¶å€™ï¼Œå°†å…¶çŠ¶æ€å˜æ›´ä¸ºæ´»åŠ¨ä¸­
* çŠ¶æ€ä¸º5ï¼ˆæ´»åŠ¨ä¸­ï¼‰ï¼šå¯¹äºå·²ç»å¼€å§‹ä½†æ˜¯å·²ç»è¿‡äº†ç»“æŸæ—¶é—´çš„æ´»åŠ¨ï¼Œå°†å…¶çŠ¶æ€å˜æ›´ä¸ºå…³é—­
* æŒç»­å¤„ç†ï¼šé€»è¾‘é€šè¿‡åœ¨uæ€§èƒ½æ¢ç§æ›´æ–°æ´»åŠ¨åˆ—è¡¨æ¥æŒç»­å¤„ç†æ›´å¤šæ´»åŠ¨


```java
@Component
public class LotteryXxlJob {

    private Logger logger = LoggerFactory.getLogger(LotteryXxlJob.class);

    @Resource
    private IActivityDeploy activityDeploy;

    @Resource
    private IStateHandler stateHandler;

    @XxlJob("lotteryActivityStateJobHandler")
    public void lotteryActivityStateJobHandler() throws Exception {
        logger.info("æ‰«ææ´»åŠ¨çŠ¶æ€ Begin");

        List<ActivityVO> activityVOList = activityDeploy.scanToDoActivityList(0L);
        if (activityVOList.isEmpty()){
            logger.info("æ‰«ææ´»åŠ¨çŠ¶æ€ End æš‚æ— ç¬¦åˆéœ€è¦æ‰«æçš„æ´»åŠ¨åˆ—è¡¨");
            return;
        }

        while (!activityVOList.isEmpty()) {
            for (ActivityVO activityVO : activityVOList) {
                Integer state = activityVO.getState();
                switch (state) {
                    // æ´»åŠ¨çŠ¶æ€ä¸ºå®¡æ ¸é€šè¿‡ï¼Œåœ¨ä¸´è¿‘æ´»åŠ¨å¼€å¯æ—¶é—´å‰ï¼Œå®¡æ ¸æ´»åŠ¨ä¸ºæ´»åŠ¨ä¸­ã€‚åœ¨ä½¿ç”¨æ´»åŠ¨çš„æ—¶å€™ï¼Œéœ€è¦ä¾ç…§æ´»åŠ¨çŠ¶æ€æ ¸æ—¶é—´ä¸¤ä¸ªå­—æ®µè¿›è¡Œåˆ¤æ–­å’Œä½¿ç”¨ã€‚
                    case 4:
                        Result state4Result = stateHandler.doing(activityVO.getActivityId(), Constants.ActivityState.PASS);
                        logger.info("æ‰«ææ´»åŠ¨çŠ¶æ€ä¸ºæ´»åŠ¨ä¸­ ç»“æœï¼š{} activityIdï¼š{} activityNameï¼š{} creatorï¼š{}", JSON.toJSONString(state4Result), activityVO.getActivityId(), activityVO.getActivityName(), activityVO.getCreator());
                        break;
                    // æ‰«ææ—¶é—´å·²è¿‡æœŸçš„æ´»åŠ¨ï¼Œä»æ´»åŠ¨ä¸­çŠ¶æ€å˜æ›´ä¸ºå…³é—­çŠ¶æ€
                    case 5:
                        if (activityVO.getEndDateTime().before(new Date())){
                            Result state5Result = stateHandler.close(activityVO.getActivityId(), Constants.ActivityState.DOING);
                            logger.info("æ‰«ææ´»åŠ¨çŠ¶æ€ä¸ºå…³é—­ ç»“æœï¼š{} activityIdï¼š{} activityNameï¼š{} creatorï¼š{}", JSON.toJSONString(state5Result), activityVO.getActivityId(), activityVO.getActivityName(), activityVO.getCreator());
                        }
                        break;
                    default:
                        break;
                }
            }

            // è·å–é›†åˆä¸­æœ€åä¸€æ¡è®°å½•ï¼Œç»§ç»­æ‰«æåé¢10æ¡è®°å½•
            ActivityVO activityVO = activityVOList.get(activityVOList.size() - 1);
            activityVOList = activityDeploy.scanToDoActivityList(activityVO.getId());
        }

        logger.info("æ‰«ææ´»åŠ¨çŠ¶æ€ End");

    }

}

```

## æ‰«æåº“è¡¨è¡¥å¿å‘è´§å•MQæ¶ˆæ¯

* å¾ªç¯çš„æ–¹å¼æŠŠæ¯ä¸ªåº“ä¸‹çš„å¤šå¼ è¡¨ä¸­çš„æ¯æ¡ç”¨æˆ·è®°å½•ï¼Œéƒ½è¿›è¡Œæ‰«æã€‚æ‰€ä»¥éœ€è¦åœ¨åˆ†åº“åˆ†è¡¨ç»„ä»¶ä¸­ï¼Œæä¾›å‡ºå¯ä»¥è®¾ç½®è·¯ç”±åˆ°çš„åº“å’Œè¡¨ï¼Œè¿™æ ·å°±å¯ä»¥æ»¡è¶³æˆ‘ä»¬æ‰«æçš„åŠ¨ä½œäº†
* åœ¨ application åº”ç”¨å±‚ä¸‹çš„ worker åŒ… LotteryXxlJob ä¸­ï¼Œæ·»åŠ å…³äºæ‰«æåº“è¡¨è¡¥å¿æ¶ˆæ¯å‘é€çš„ä»»åŠ¡ï¼Œå¹¶åœ¨å¼€å‘å®ŒæˆåæŠŠä»»åŠ¡é…ç½®åˆ° xxl-job ä»»åŠ¡è°ƒåº¦åå°ä¸­
* å®¡æ ¸é€šè¿‡ -> æ‰«æä¸ºæ´»åŠ¨ä¸­
* æ´»åŠ¨ä¸­å·²è¿‡æœŸæ—¶é—´ -> æ‰«æä¸ºæ´»åŠ¨å…³é—­
![å›¾ 6](../images/b3d776ffb17925cda95a13c4a07d238acf940f8b27ceb0e7c6cafe77ccf8bc08.png)  



```java
package cn.itedus.lottery.application.worker;

import cn.bugstack.middleware.db.router.strategy.IDBRouterStrategy;
import cn.itedus.lottery.application.mq.producer.KafkaProducer;
import cn.itedus.lottery.common.Constants;
import cn.itedus.lottery.common.Result;
import cn.itedus.lottery.domain.activity.model.vo.ActivityVO;
import cn.itedus.lottery.domain.activity.model.vo.InvoiceVO;
import cn.itedus.lottery.domain.activity.service.deploy.IActivityDeploy;
import cn.itedus.lottery.domain.activity.service.partake.IActivityPartake;
import cn.itedus.lottery.domain.activity.service.stateflow.IStateHandler;
import com.alibaba.fastjson.JSON;
import com.xxl.job.core.context.XxlJobHelper;
import com.xxl.job.core.handler.annotation.XxlJob;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.kafka.support.SendResult;
import org.springframework.stereotype.Component;
import org.springframework.util.concurrent.ListenableFuture;
import org.springframework.util.concurrent.ListenableFutureCallback;

import javax.annotation.Resource;
import java.util.Date;
import java.util.List;

/**
 * @description: æŠ½å¥–ä¸šåŠ¡ï¼Œä»»åŠ¡é…ç½®
 * @author: å°å‚…å“¥ï¼Œå¾®ä¿¡ï¼šfustack
 * @date: 2021/11/6
 * @github: https://github.com/fuzhengwei
 * @Copyright: å…¬ä¼—å·ï¼šbugstackè™«æ´æ ˆ | åšå®¢ï¼šhttps://bugstack.cn - æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼
 */
@Component
public class LotteryXxlJob {

    private Logger logger = LoggerFactory.getLogger(LotteryXxlJob.class);

    @Resource
    private IActivityDeploy activityDeploy;

    @Resource
    private IActivityPartake activityPartake;

    @Resource
    private IStateHandler stateHandler;

    @Resource
    private IDBRouterStrategy dbRouter;


    @Resource
    private KafkaProducer kafkaProducer;

    @XxlJob("lotteryActivityStateJobHandler")
    public void lotteryActivityStateJobHandler() throws Exception {
        logger.info("æ‰«ææ´»åŠ¨çŠ¶æ€ Begin");

        List<ActivityVO> activityVOList = activityDeploy.scanToDoActivityList(0L);
        if (activityVOList.isEmpty()) {
            logger.info("æ‰«ææ´»åŠ¨çŠ¶æ€ End æš‚æ— ç¬¦åˆéœ€è¦æ‰«æçš„æ´»åŠ¨åˆ—è¡¨");
            return;
        }

        while (!activityVOList.isEmpty()) {
            for (ActivityVO activityVO : activityVOList) {
                Integer state = activityVO.getState();
                switch (state) {
                    // æ´»åŠ¨çŠ¶æ€ä¸ºå®¡æ ¸é€šè¿‡ï¼Œåœ¨ä¸´è¿‘æ´»åŠ¨å¼€å¯æ—¶é—´å‰ï¼Œå®¡æ ¸æ´»åŠ¨ä¸ºæ´»åŠ¨ä¸­ã€‚åœ¨ä½¿ç”¨æ´»åŠ¨çš„æ—¶å€™ï¼Œéœ€è¦ä¾ç…§æ´»åŠ¨çŠ¶æ€æ ¸æ—¶é—´ä¸¤ä¸ªå­—æ®µè¿›è¡Œåˆ¤æ–­å’Œä½¿ç”¨ã€‚
                    case 4:
                        Result state4Result = stateHandler.doing(activityVO.getActivityId(), Constants.ActivityState.PASS);
                        logger.info("æ‰«ææ´»åŠ¨çŠ¶æ€ä¸ºæ´»åŠ¨ä¸­ ç»“æœï¼š{} activityIdï¼š{} activityNameï¼š{} creatorï¼š{}", JSON.toJSONString(state4Result), activityVO.getActivityId(), activityVO.getActivityName(), activityVO.getCreator());
                        break;
                    // æ‰«ææ—¶é—´å·²è¿‡æœŸçš„æ´»åŠ¨ï¼Œä»æ´»åŠ¨ä¸­çŠ¶æ€å˜æ›´ä¸ºå…³é—­çŠ¶æ€ã€è¿™é‡Œä¹Ÿå¯ä»¥ç»†åŒ–ä¸º2ä¸ªä»»åŠ¡æ¥å¤„ç†ï¼Œä¹Ÿå¯ä»¥æŠŠæ—¶é—´åˆ¤æ–­æ”¾åˆ°æ•°æ®åº“ä¸­æ“ä½œã€‘
                    case 5:
                        if (activityVO.getEndDateTime().before(new Date())) {
                            Result state5Result = stateHandler.close(activityVO.getActivityId(), Constants.ActivityState.DOING);
                            logger.info("æ‰«ææ´»åŠ¨çŠ¶æ€ä¸ºå…³é—­ ç»“æœï¼š{} activityIdï¼š{} activityNameï¼š{} creatorï¼š{}", JSON.toJSONString(state5Result), activityVO.getActivityId(), activityVO.getActivityName(), activityVO.getCreator());
                        }
                        break;
                    default:
                        break;
                }
            }

            // è·å–é›†åˆä¸­æœ€åä¸€æ¡è®°å½•ï¼Œç»§ç»­æ‰«æåé¢10æ¡è®°å½•
            ActivityVO activityVO = activityVOList.get(activityVOList.size() - 1);
            activityVOList = activityDeploy.scanToDoActivityList(activityVO.getId());
        }

        logger.info("æ‰«ææ´»åŠ¨çŠ¶æ€ End");

    }

    @XxlJob("lotteryOrderMQStateJobHandler")
    public void lotteryOrderMQStateJobHandler() throws Exception {
        // éªŒè¯å‚æ•°
        String jobParam = XxlJobHelper.getJobParam();
        if (null == jobParam) {
            logger.info("æ‰«æç”¨æˆ·æŠ½å¥–å¥–å“å‘æ”¾MQçŠ¶æ€[Table = 2*4] é”™è¯¯ params is null");
            return;
        }

        // è·å–åˆ†å¸ƒå¼ä»»åŠ¡é…ç½®å‚æ•°ä¿¡æ¯ å‚æ•°é…ç½®æ ¼å¼ï¼š1,2,3 ä¹Ÿå¯ä»¥æ˜¯æŒ‡å®šæ‰«æä¸€ä¸ªï¼Œä¹Ÿå¯ä»¥é…ç½®å¤šä¸ªåº“ï¼ŒæŒ‰ç…§éƒ¨ç½²çš„ä»»åŠ¡é›†ç¾¤è¿›è¡Œæ•°é‡é…ç½®ï¼Œå‡æ‘Šåˆ†åˆ«æ‰«ææ•ˆç‡æ›´é«˜
        String[] params = jobParam.split(",");
        logger.info("æ‰«æç”¨æˆ·æŠ½å¥–å¥–å“å‘æ”¾MQçŠ¶æ€[Table = 2*4] å¼€å§‹ paramsï¼š{}", JSON.toJSONString(params));

        if (params.length == 0) {
            logger.info("æ‰«æç”¨æˆ·æŠ½å¥–å¥–å“å‘æ”¾MQçŠ¶æ€[Table = 2*4] ç»“æŸ params is null");
            return;
        }

        // è·å–åˆ†åº“åˆ†è¡¨é…ç½®ä¸‹çš„åˆ†è¡¨æ•°
        int tbCount = dbRouter.tbCount();

        // å¾ªç¯è·å–æŒ‡å®šæ‰«æåº“
        for (String param : params) {
            // è·å–å½“å‰ä»»åŠ¡æ‰«æçš„æŒ‡å®šåˆ†åº“
            int dbCount = Integer.parseInt(param);

            // åˆ¤æ–­é…ç½®æŒ‡å®šæ‰«æåº“æ•°ï¼Œæ˜¯å¦å­˜åœ¨
            if (dbCount > dbRouter.dbCount()) {
                logger.info("æ‰«æç”¨æˆ·æŠ½å¥–å¥–å“å‘æ”¾MQçŠ¶æ€[Table = 2*4] ç»“æŸ dbCount not exist");
                continue;
            }

            // å¾ªç¯æ‰«æå¯¹åº”è¡¨
            for (int i = 0; i < tbCount; i++) {

                // æ‰«æåº“è¡¨æ•°æ®
                List<InvoiceVO> invoiceVOList = activityPartake.scanInvoiceMqState(dbCount, i);
                logger.info("æ‰«æç”¨æˆ·æŠ½å¥–å¥–å“å‘æ”¾MQçŠ¶æ€[Table = 2*4] æ‰«æåº“ï¼š{} æ‰«æè¡¨ï¼š{} æ‰«ææ•°ï¼š{}", dbCount, i, invoiceVOList.size());

                // è¡¥å¿ MQ æ¶ˆæ¯
                for (InvoiceVO invoiceVO : invoiceVOList) {

                    ListenableFuture<SendResult<String, Object>> future = kafkaProducer.sendLotteryInvoice(invoiceVO);
                    future.addCallback(new ListenableFutureCallback<SendResult<String, Object>>() {

                        @Override
                        public void onSuccess(SendResult<String, Object> stringObjectSendResult) {
                            // MQ æ¶ˆæ¯å‘é€å®Œæˆï¼Œæ›´æ–°æ•°æ®åº“è¡¨ user_strategy_export.mq_state = 1
                            activityPartake.updateInvoiceMqState(invoiceVO.getuId(), invoiceVO.getOrderId(), Constants.MQState.COMPLETE.getCode());
                        }

                        @Override
                        public void onFailure(Throwable throwable) {
                            // MQ æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œæ›´æ–°æ•°æ®åº“è¡¨ user_strategy_export.mq_state = 2 ã€ç­‰å¾…å®šæ—¶ä»»åŠ¡æ‰«ç è¡¥å¿MQæ¶ˆæ¯ã€‘
                            activityPartake.updateInvoiceMqState(invoiceVO.getuId(), invoiceVO.getOrderId(), Constants.MQState.FAIL.getCode());
                        }

                    });
                }
            }

        }

        logger.info("æ‰«æç”¨æˆ·æŠ½å¥–å¥–å“å‘æ”¾MQçŠ¶æ€[Table = 2*4] å®Œæˆ paramï¼š{}", JSON.toJSONString(params));

    }

}


```

* lotteryActivityStateJobHandler
  * å®šæœŸæ‰«ææ´»åŠ¨çŠ¶æ€ï¼Œå¹¶æ ¹æ®å½“å‰çŠ¶æ€å’Œæ—¶é—´æ¡ä»¶æ›´æ–°çŠ¶æ€
  * çŠ¶æ€ä¸º4ï¼ˆå®¡æ ¸é€šè¿‡ï¼‰: åœ¨æ´»åŠ¨å¼€å§‹å‰å°†çŠ¶æ€æ›´æ–°ä¸ºâ€œæ´»åŠ¨ä¸­â€
  * çŠ¶æ€ä¸º5ï¼ˆæ´»åŠ¨ä¸­ï¼‰: å¦‚æœæ´»åŠ¨å·²è¿‡ç»“æŸæ—¶é—´ï¼Œåˆ™å°†çŠ¶æ€æ›´æ–°ä¸ºâ€œå…³é—­â€
  * è°ƒç”¨ activityDeploy.scanToDoActivityList æ–¹æ³•è·å–å¾…å¤„ç†çš„æ´»åŠ¨åˆ—è¡¨
  * éå†æ´»åŠ¨åˆ—è¡¨ï¼Œæ ¹æ®æ´»åŠ¨çš„å½“å‰çŠ¶æ€å’Œæ—¶é—´æ¡ä»¶æ‰§è¡ŒçŠ¶æ€æ›´æ–°
  * æ—¥å¿—è®°å½•æ“ä½œç»“æœ
  * å¾ªç¯åˆ†é¡µè·å–æ›´å¤šå¾…å¤„ç†æ´»åŠ¨ï¼Œç›´è‡³æ²¡æœ‰æ›´å¤šæ´»åŠ¨
* lotteryOrderMQStateJobHandler
  * å¤„ç†å’Œè¡¥å¿ä¸­å¥–å‘è´§å•çš„æ¶ˆæ¯é˜Ÿåˆ—çŠ¶æ€ï¼Œç¡®ä¿æ‰€æœ‰åº”å‘é€çš„æ¶ˆæ¯éƒ½æ­£ç¡®å‘é€åˆ°Kafkaï¼Œå¹¶åœ¨æ¶ˆæ¯å‘é€å¤±è´¥æ—¶è¿›è¡Œé‡è¯•
  * è§£æXXL-Jobä¼ å…¥çš„ä»»åŠ¡å‚æ•°ï¼Œç¡®å®šè¦æ‰«æçš„æ•°æ®åº“åˆ†åº“ç¼–å·
  * å¯¹æŒ‡å®šçš„æ•°æ®åº“åˆ†åº“è¿›è¡Œæ‰«æï¼Œè·å–æ‰€æœ‰å¾…å‘é€çš„ä¸­å¥–å‘è´§å•
  * å¯¹è·å–çš„ä¸­å¥–å‘è´§å•åˆ—è¡¨è¿›è¡Œéå†ï¼Œè°ƒç”¨ kafkaProducer.sendLotteryInvoice æ–¹æ³•å‘é€Kafkaæ¶ˆæ¯
  * ä½¿ç”¨ ListenableFuture å¯¹è±¡å¤„ç†å¼‚æ­¥å‘é€ç»“æœ
  * onSuccess: å‘é€æˆåŠŸåï¼Œæ›´æ–°å‘è´§å•çš„æ¶ˆæ¯çŠ¶æ€ä¸ºå®Œæˆ
  * onFailure: å‘é€å¤±è´¥åï¼Œæ›´æ–°å‘è´§å•çš„æ¶ˆæ¯çŠ¶æ€ä¸ºå¤±è´¥ï¼Œç­‰å¾…ä¸‹æ¬¡æ‰«æé‡è¯•
* 




## è®¾è®¡æ»‘åŠ¨åº“å­˜åˆ†å¸ƒå¼é”å¤„ç†æ´»åŠ¨ç§’æ€

* ä¼˜åŒ–é”çš„é¢—ç²’åº¦åŠ›åº¦ï¼Œä¸è¦æŠŠé”ç›´æ¥æ”¾åˆ°æ´»åŠ¨ç¼–å·ä¸Šï¼Œè¿™æ ·åœ¨æç«¯ä¸´ç•Œæƒ…å†µä¸‹ä¼šå‡ºç°ç§’æ€è§£é”å¤±è´¥ï¼Œå¯¼è‡´åº“å­˜æœ‰å‰©ä½™ä½†ä¸èƒ½ä¸‹å•çš„æƒ…å†µã€‚æ‰€ä»¥éœ€è¦å¢åŠ é”çš„é¢—ç²’åº¦ï¼Œä»¥æ»‘åŠ¨åº“å­˜å‰©ä½™ç¼–å·çš„æ–¹å¼è¿›è¡ŒåŠ é”ï¼Œä¾‹å¦‚ 100001_1ã€100001_2ã€100001_3
* å¢åŠ ç¼“å­˜æ‰£å‡åº“å­˜åï¼Œå‘é€ MQ æ¶ˆæ¯è¿›è¡Œå¼‚æ­¥æ›´æ–°æ•°æ®åº“ä¸­æ´»åŠ¨åº“å­˜ï¼Œåšæœ€ç»ˆæ•°æ®ä¸€è‡´æ€§å¤„ç†ã€‚è¿™ä¸€éƒ¨åˆ†å¦‚æœä½ çš„ç³»ç»Ÿå¹¶å‘ä½“é‡è¾ƒå¤§ï¼Œè¿˜éœ€è¦æŠŠ MQ çš„æ•°æ®ä¸è¦ç›´æ¥å¯¹åº“æ›´æ–°ï¼Œè€Œæ˜¯æ›´æ–°åˆ°ç¼“å­˜ä¸­ï¼Œå†ç”±ä»»åŠ¡æœ€é˜¶æ®µåŒæ­¥ï¼Œä»¥æ­¤å‡å°‘å¯¹æ•°æ®åº“è¡¨çš„æ“ä½œ


![å›¾ 7](../images/a748e7ea225a917c7b29997d02cea0f4c18166fa7251e384015b22d83c4614a7.png)  


* ä¼˜åŒ–æ´»åŠ¨é¢†åŸŸï¼Œæ´»åŠ¨å‚ä¸æµç¨‹ä¸­çš„åº“å­˜æ‰£å‡æ“ä½œï¼Œè¿™éƒ¨åˆ†æˆ‘ä»¬åŸæ¥æ˜¯ä½¿ç”¨æ•°æ®åº“è¡Œçº§é”ğŸ” å¤„ç†çš„åº“å­˜æ‰£å‡ï¼Œä½†å› ä¸ºä¼šå­˜åœ¨å¹¶å‘é—®é¢˜æ‰€ä»¥è¿™é‡Œä¼˜åŒ–ä¸º Redis åˆ†å¸ƒå¼é”è¿›è¡Œå¤„ç†
* æ´»åŠ¨é¢†å–å®Œæˆåï¼Œå…¶å®è¿™ä¸ªæ—¶å€™åªæ˜¯æŠŠç¼“å­˜çš„åº“å­˜æ‰£æ‰äº†ï¼Œä½†æ•°æ®åº“ä¸­çš„åº“å­˜å¹¶æ²¡æœ‰æ‰£å‡ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å‘é€ä¸€ä¸ª MQ æ¶ˆæ¯ï¼Œæ¥å¯¹æ•°æ®åº“ä¸­çš„åº“å­˜è¿›è¡Œå¤„ç†ã€‚å› ä¸º MQ å¯ä»¥æ¶ˆå³°å› æ­¤åœ¨é™ä½ MQ åˆ†ç‰‡çš„æƒ…å†µä¸‹ï¼Œæ¶ˆè´¹æ•ˆç‡æœ‰æ‰€ä¸‹é™ï¼Œå¹¶ä¸ä¼šå¯¹æ•°æ®åº“é€ æˆå‹åŠ›ï¼Œä¿è¯æœ€ç»ˆæ•°æ®ä¸€è‡´æ€§å³å¯ã€‚ä½†ä¹Ÿæœ‰ä¾‹å¤–ï¼Œæ‰€ä»¥æˆ‘ä»¬æåˆ°å¯ä»¥ä½¿ç”¨å®šæ—¶ä»»åŠ¡æ¥æ›´æ–°æ•°æ®åº“åº“å­˜
* å³ä½¿æ˜¯ä½¿ç”¨ Redis åˆ†å¸ƒå¼é”ï¼Œæˆ‘ä»¬ä¹Ÿä¸å¸Œæœ›æŠŠé”çš„é¢—ç²’åº¦æ”¾çš„å¤ªç²—ï¼Œå¦åˆ™è¿˜æ˜¯ä¼šå‡ºç°æ´»åŠ¨æœ‰åº“å­˜ä½†ä¸èƒ½ç§’æ€ï¼Œæç¤ºâ€œæ´»åŠ¨è¿‡äºç«çˆ†â€
* æˆ‘ä»¬å°±éœ€è¦æŒ‰ç…§æ´»åŠ¨ç¼–å·æŠŠåº“å­˜é”çš„é¢—ç²’åº¦ç¼©å°ï¼Œå®é™…æ“ä½œä¹Ÿå¹¶ä¸å¤æ‚ï¼Œåªæ˜¯æŠŠæ´»åŠ¨ID+åº“å­˜æ‰£å‡åçš„å€¼ä¸€èµ·ä½œä¸ºåˆ†å¸ƒå¼é”çš„Keyï¼Œè¿™æ ·å°±ç¼©å°äº†é”çš„é¢—ç²’åº¦


**åœ¨æ´»åŠ¨é¢†åŸŸå±‚çš„é¢†å–æ´»åŠ¨æŠ½è±¡ç±» BaseActivityPartake æ·»åŠ æ–¹æ³• subtractionActivityStockByRedisã€recoverActivityCacheStockByRedisï¼Œåˆ†åˆ«ç”¨æˆ· Redis åº“å­˜æ‰£å‡å’ŒåŠ é” Key çš„å¤„ç†**

### åº“å­˜æ‰£å‡æ“ä½œ

```java
@Override
public StockResult subtractionActivityStockByRedis(String uId, Long activityId, Integer stockCount) {

    //  1. è·å–æŠ½å¥–æ´»åŠ¨åº“å­˜ Key
    String stockKey = Constants.RedisKey.KEY_LOTTERY_ACTIVITY_STOCK_COUNT(activityId);
    
    // 2. æ‰£å‡åº“å­˜ï¼Œç›®å‰å ç”¨åº“å­˜æ•°
    Integer stockUsedCount = (int) redisUtil.incr(stockKey, 1);
    
    // 3. è¶…å‡ºåº“å­˜åˆ¤æ–­ï¼Œè¿›è¡Œæ¢å¤åŸå§‹åº“å­˜
    if (stockUsedCount > stockCount) {
        redisUtil.decr(stockKey, 1);
        return new StockResult(Constants.ResponseCode.UN_ERROR.getCode(), Constants.ResponseCode.UN_ERROR.getInfo());
    }
    
    // 4. ä»¥æ´»åŠ¨åº“å­˜å ç”¨ç¼–å·ï¼Œç”Ÿæˆå¯¹åº”åŠ é”Keyï¼Œç»†åŒ–é”çš„é¢—ç²’åº¦
    String stockTokenKey = Constants.RedisKey.KEY_LOTTERY_ACTIVITY_STOCK_COUNT_TOKEN(activityId, stockUsedCount);
    
    // 5. ä½¿ç”¨ Redis.setNx åŠ ä¸€ä¸ªåˆ†å¸ƒå¼é”
    boolean lockToken = redisUtil.setNx(stockTokenKey, 350L);
    if (!lockToken) {
        logger.info("æŠ½å¥–æ´»åŠ¨{}ç”¨æˆ·ç§’æ€{}æ‰£å‡åº“å­˜ï¼Œåˆ†å¸ƒå¼é”å¤±è´¥ï¼š{}", activityId, uId, stockTokenKey);
        return new StockResult(Constants.ResponseCode.UN_ERROR.getCode(), Constants.ResponseCode.UN_ERROR.getInfo());
    }
    return new StockResult(Constants.ResponseCode.SUCCESS.getCode(), Constants.ResponseCode.SUCCESS.getInfo(), stockTokenKey, stockCount - stockUsedCount);
}


```

* ä»£ç ä¸­çš„æ³¨é‡Šå°±æ˜¯æ•´ä¸ªæ“ä½œæµç¨‹ï¼Œåˆ›å»º Keyã€å ç”¨åº“å­˜ã€åˆ¤æ–­åº“å­˜ã€ä»¥å ç”¨åº“å­˜çš„ç¼–å·åšä¸ºåŠ é”keyã€è°ƒç”¨ setNx åŠ ä¸€ä¸ªåˆ†å¸ƒå¼é”ï¼Œæœ€ç»ˆå®Œæˆæ•´ä¸ªç§’æ€æ‰£å‡åº“å­˜çš„åŠ¨ä½œ
* è¿™é‡Œè¿˜æœ‰ä¸€äº›å…¶ä»–çš„å®ç°æ–¹å¼ï¼Œä¾‹å¦‚ï¼šluaè„šæœ¬ã€zkã€jvmå±‚ï¼Œéƒ½å¯ä»¥å¤„ç†ï¼Œä½†ç»è¿‡éªŒè¯ luaè„šæœ¬ä¼šæœ‰ä¸€å®šçš„è€—æ—¶ï¼Œå¹¶å‘è¾ƒé«˜æ—¶ä¼šæœ‰é—®é¢˜ã€‚
* ç§’æ€çš„è®¾è®¡åŸåˆ™æ˜¯ä¿è¯ä¸è¶…å–ï¼Œä½†ä¸ä¸€å®šä¿è¯100ä¸ªåº“å­˜å®Œå…¨æ¶ˆè€—æ‰ï¼Œå› ä¸ºå¯èƒ½ä¼šæœ‰ä¸€äº›é”å¤±è´¥çš„æƒ…å†µã€‚ä¸è¿‡åœ¨åº“å­˜æ•°æ®æœ€ç»ˆä¸€è‡´æ€§ä»»åŠ¡å¤„ç†ä¸‹ï¼ŒåŸºæœ¬ä¿è¯3ä¸ª9åˆ°4ä¸ª9çš„å¯ç”¨ç‡è¿˜æ˜¯æ²¡é—®é¢˜çš„
* å¦‚æœè¯´ä½ çš„åº“å­˜ç§’æ€tpså·²ç»åˆ°10çº§ä»¥ä¸Šï¼Œä¸€èˆ¬å•keyåœ¨10ä¸‡ä»¥ä¸‹æ˜¯å¯é çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™å°±éœ€è¦è¿›è¡Œåº“å­˜åˆ†ç‰‡ï¼ŒæŠŠè·¯ç”±æ˜¯æ€æƒ³ç”¨åˆ° Redis ä½¿ç”¨ä¸Šï¼Œä¸åŒçš„ç”¨æˆ·è¿›å…¥ Redis è¿›è¡Œç§’æ€å¤„ç†æ—¶ï¼ŒæŠŠä»–çš„åº“å­˜æ“ä½œè·¯ç”±åˆ°å±äºä»–çš„åˆ†ç»„ä¸Šè¿›è¡Œå¤„ç†ï¼Œé‚£ä¹ˆè¿™æ ·å°±å¯ä»¥æ¨ªå‘æ‰©å±•äº†
* ç”Ÿæˆåº“å­˜Key: ä½¿ç”¨æ´»åŠ¨IDæ„å»ºä¸€ä¸ªåº“å­˜Keyï¼ˆstockKeyï¼‰ï¼Œè¿™ä¸ªKeyç”¨äºåœ¨Redisä¸­æ ‡è¯†å’Œè¿½è¸ªç‰¹å®šæ´»åŠ¨çš„åº“å­˜æ•°é‡
* æ‰£å‡åº“å­˜: ä½¿ç”¨ redisUtil.incr(stockKey, 1) åŸå­åœ°å¢åŠ åº“å­˜ä½¿ç”¨è®¡æ•°ï¼Œè¿™æ„å‘³ç€æ¯è°ƒç”¨ä¸€æ¬¡è¿™ä¸ªæ–¹æ³•ï¼Œåº“å­˜å ç”¨æ•°å°±å¢åŠ ä¸€ã€‚è¿™ä¸ªæ“ä½œæ˜¯åŸå­çš„ï¼Œä¿è¯äº†åœ¨é«˜å¹¶å‘ç¯å¢ƒä¸‹åº“å­˜æ•°æ®çš„æ­£ç¡®æ€§
* è¶…å‡ºåº“å­˜åˆ¤æ–­ä¸æ¢å¤: åˆ¤æ–­å½“å‰å ç”¨çš„åº“å­˜æ•°ï¼ˆstockUsedCountï¼‰æ˜¯å¦è¶…è¿‡äº†æ€»åº“å­˜ï¼ˆstockCountï¼‰ã€‚å¦‚æœè¶…å‡ºï¼Œä½¿ç”¨ redisUtil.decr(stockKey, 1) åŸå­åœ°å‡å°‘åº“å­˜ä½¿ç”¨è®¡æ•°ï¼Œå®é™…ä¸Šæ˜¯å°†è¯¯å¢çš„åº“å­˜é‡æ’¤é”€ï¼Œç„¶åè¿”å›åº“å­˜ä¸è¶³çš„ç»“æœ
* ç”Ÿæˆåˆ†å¸ƒå¼é”Keyï¼šæ ¹æ®æ´»åŠ¨IDå’Œå½“å‰çš„åº“å­˜å ç”¨ç¼–å·ï¼ˆåº“å­˜ä½¿ç”¨çš„åºå·ï¼‰ç”Ÿæˆä¸€ä¸ªåˆ†å¸ƒå¼é”çš„Keyï¼ˆstockTokenKeyï¼‰ã€‚è¿™ä¸ªKeyåœ¨Redisä¸­ç”¨ä½œåˆ†å¸ƒå¼é”ï¼Œé˜²æ­¢åœ¨åº“å­˜æ‰£å‡æ“ä½œä¸­å‡ºç°å¹¶å‘é—®é¢˜
* å°è¯•è·å–åˆ†å¸ƒå¼é”ï¼šä½¿ç”¨ redisUtil.setNx(stockTokenKey, 350L) å°è¯•è®¾ç½®åˆ†å¸ƒå¼é”ï¼Œå…¶ä¸­350Lå¯èƒ½è¡¨ç¤ºé”çš„æŒæœ‰æ—¶é—´ï¼ˆ350msï¼‰ã€‚å¦‚æœè®¾ç½®å¤±è´¥ï¼ˆè¿”å›falseï¼‰ï¼Œè¡¨ç¤ºé”å½“å‰è¢«å…¶ä»–çº¿ç¨‹æŒæœ‰ï¼Œæ­¤æ—¶è®°å½•æ—¥å¿—å¹¶è¿”å›æ“ä½œå¤±è´¥çš„ç»“æœ
* è¿”å›æ“ä½œç»“æœ: å¦‚æœé”è·å–æˆåŠŸï¼Œè¿”å›æ“ä½œæˆåŠŸçš„ç»“æœï¼ŒåŒ…æ‹¬é”çš„Keyå’Œå‰©ä½™åº“å­˜æ•°é‡ï¼ˆæ€»åº“å­˜å‡å»å·²ä½¿ç”¨åº“å­˜ï¼‰
* å¦‚æœæœ€åçš„æ“ä½œæ˜¯æˆåŠŸçš„ï¼Œé‚£ä¹ˆæ­£å¸¸åˆ é™¤æ‰è¿™ä¸ªåŠ é”çš„ Key å°±å¯ä»¥äº†ï¼Œå› ä¸ºä¸‹ä¸€ä¸ªç”¨æˆ·è·å–çš„åˆ°çš„åº“å­˜æ»‘å—åˆæ˜¯æ–°çš„äº†ï¼Œæ—§ Key å·²ç»æ²¡æœ‰ç”¨äº†ã€‚


3. æ´»åŠ¨

### å¹¶å‘é”åˆ é™¤å¤„ç†

```java
@Override
public void recoverActivityCacheStockByRedis(Long activityId, String tokenKey, String code) {
    // åˆ é™¤åˆ†å¸ƒå¼é” Key
    redisUtil.del(tokenKey);
}

```

* å¦‚æœæœ€åçš„æ“ä½œæ˜¯æˆåŠŸçš„ï¼Œé‚£ä¹ˆæ­£å¸¸åˆ é™¤æ‰è¿™ä¸ªåŠ é”çš„ Key å°±å¯ä»¥äº†ï¼Œå› ä¸ºä¸‹ä¸€ä¸ªç”¨æˆ·è·å–çš„åˆ°çš„åº“å­˜æ»‘å—åˆæ˜¯æ–°çš„äº†ï¼Œæ—§ Key å·²ç»æ²¡æœ‰ç”¨äº†

###  æ´»åŠ¨ç§’æ€æµç¨‹å¤„ç†
* æŸ¥è¯¢æœªæ¶ˆè€—çš„æŠ½å¥–æ´»åŠ¨: é¦–å…ˆæ£€æŸ¥æ˜¯å¦å­˜åœ¨çŠ¶æ€ä¸ºæœªå®Œæˆçš„æŠ½å¥–é¢†å–æ´»åŠ¨ï¼Œå¦‚æœå­˜åœ¨ï¼Œç›´æ¥è¿”å›è¯¥é¢†å–ç»“æœï¼Œå…è®¸ç”¨æˆ·ç»§ç»­ä¹‹å‰çš„æŠ½å¥–è¿‡ç¨‹ã€‚
* æŸ¥è¯¢æ´»åŠ¨è´¦å•: è·å–æ´»åŠ¨çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬åº“å­˜ã€æ´»åŠ¨çŠ¶æ€ã€æ—¥æœŸåŠä¸ªäººå‚ä¸æ¬¡æ•°ã€‚
* æ´»åŠ¨ä¿¡æ¯æ ¡éªŒ: å¯¹è·å–çš„æ´»åŠ¨è´¦å•è¿›è¡Œæ ¡éªŒï¼Œç¡®ä¿æ´»åŠ¨å¤„äºå¯å‚ä¸çš„çŠ¶æ€ï¼Œæ—¶é—´æ­£ç¡®ï¼Œå¹¶ä¸”åº“å­˜å……è¶³
* æ‰£å‡æ´»åŠ¨åº“å­˜: é€šè¿‡Redisè¿›è¡Œåº“å­˜æ‰£å‡ã€‚åº“å­˜æ‰£å‡æ˜¯é€šè¿‡ç”Ÿæˆä¸€ä¸ªç»†ç²’åº¦çš„é”çš„Keyæ¥è¿›è¡Œæ“ä½œï¼Œå¦‚æœæ‰£å‡å¤±è´¥ï¼ˆå¦‚åº“å­˜ä¸è¶³ï¼‰ï¼Œå°†ä¼šæ¢å¤ä¹‹å‰çš„æ“ä½œå¹¶è¿”å›é”™è¯¯
* è®°å½•é¢†å–æ´»åŠ¨ä¿¡æ¯: åœ¨æ•°æ®åº“ä¸­è®°å½•ç”¨æˆ·é¢†å–çš„æ´»åŠ¨ä¿¡æ¯ã€‚è¿™åŒ…æ‹¬ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„é¢†å–IDï¼Œå¹¶å°†é¢†å–ä¿¡æ¯å†™å…¥åˆ°ç”¨æˆ·è¡¨ä¸­ã€‚
* å¤„ç†åº“å­˜æ‰£å‡åçš„æ“ä½œ: ä¸è®ºæ‰£å‡åº“å­˜æ˜¯å¦æˆåŠŸï¼Œéƒ½æ‰§è¡Œåº“å­˜æ¢å¤æ“ä½œï¼Œç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§ã€‚
* æ„å»ºè¿”å›ç»“æœ: æœ€ç»ˆæ„å»ºå¹¶è¿”å›åŒ…å«æ‰€æœ‰ç›¸å…³ä¿¡æ¯çš„ç»“æœå¯¹è±¡


## è¿™ä¸ªé¡¹ç›®æ‹Ÿè§£å†³äº†å“ªäº›éš¾é¢˜ æ€ä¹ˆè§£å†³çš„


### ç”¨æˆ·è®¢å•ä¿¡æ¯çš„ç¼“å­˜æ•°æ®åº“ä¸€è‡´æ€§

* åº“å­˜æ‰£å‡ï¼šç”¨æˆ·åœ¨ç§’æ€å¼€å§‹æ—¶ï¼Œç³»ç»Ÿé¦–å…ˆä¼šåœ¨Redisç­‰ç¼“å­˜ä¸­æ‰£å‡åº“å­˜ã€‚è¿™æ˜¯ä¸ºäº†å¿«é€Ÿå“åº”å¤§é‡ç”¨æˆ·çš„è¯·æ±‚ï¼Œå¹¶å‡å°‘å¯¹æ•°æ®åº“çš„å³æ—¶å‹åŠ›
* æˆåŠŸæ‰£å‡ç¼“å­˜åº“å­˜åï¼Œç³»ç»Ÿå°è¯•å°†ç”¨æˆ·çš„è´­ä¹°è®°å½•ï¼ˆå¦‚è®¢å•ä¿¡æ¯ï¼‰ä¿å­˜åˆ°æ•°æ®åº“ä¸­ã€‚è¿™ä¸€æ­¥æ˜¯å¿…è¦çš„ï¼Œå› ä¸ºå®ƒä¿è¯äº†å³ä½¿ç³»ç»Ÿå‡ºç°æ•…éšœï¼Œç”¨æˆ·çš„è´­ä¹°è®°å½•ä¹Ÿèƒ½æŒä¹…ä¿å­˜
* å¦‚æœåœ¨ç”¨æˆ·è®°å½•è½åº“æ—¶å¤±è´¥ï¼ˆå¯èƒ½æ˜¯ç”±äºæ•°æ®åº“é”™è¯¯ã€ç½‘ç»œé—®é¢˜ç­‰ï¼‰ï¼ŒæŒ‰ç…§ä¸šåŠ¡éœ€æ±‚ï¼Œç³»ç»Ÿå¯èƒ½éœ€è¦å°†å…ˆå‰åœ¨ç¼“å­˜ä¸­æ‰£å‡çš„åº“å­˜æ•°é‡æ¢å¤ï¼Œä»¥å…é€ æˆâ€œè™šæ‰£åº“å­˜â€çš„é—®é¢˜



### è™šæ‰£åº“å­˜

### è¶…å–é—®é¢˜

**ä¸è¶…å–æŒ‡çš„æ˜¯ä¸ä¼šå‘ç”Ÿå”®å–æ¯”å®é™…åº“å­˜å¤šçš„æƒ…å†µã€‚åœ¨ç§’æ€ç³»ç»Ÿä¸­ï¼Œç¡®ä¿è¿™ä¸€ç‚¹é€šå¸¸æ¶‰åŠä»¥ä¸‹å‡ ä¸ªæŠ€æœ¯æªæ–½ï¼š**

* ä¿è¯ä¸è¶…å–çš„æ ¸å¿ƒæ˜¯åˆ©ç”¨å¦‚Redisè¿™æ ·çš„é«˜æ€§èƒ½å­˜å‚¨ç³»ç»Ÿæ¥åšå¿«é€Ÿçš„é¢„æ‰£å‡ï¼Œå¹¶åœ¨æ“ä½œå¤±è´¥æ—¶é€šè¿‡è¡¥å¿é€»è¾‘æ¥ä¿è¯åº“å­˜çš„å‡†ç¡®æ€§
* Luaè„šæœ¬ï¼šä½¿ç”¨Redisçš„Luaè„šæœ¬æ¥æ‰§è¡Œåº“å­˜æ‰£å‡å’Œæ£€æŸ¥çš„åŸå­æ“ä½œã€‚Luaè„šæœ¬å¯ä»¥ä¿è¯åœ¨æ‰£å‡åº“å­˜çš„åŒæ—¶æ£€æŸ¥åº“å­˜é‡ï¼Œé¿å…è¶…å–ç°è±¡ï¼Œå› ä¸ºLuaè„šæœ¬åœ¨RedisæœåŠ¡å™¨ä¸Šæ˜¯åŸå­æ‰§è¡Œçš„
* Lua è„šæœ¬åœ¨ Redis ä¸­çš„ä½¿ç”¨å¯ä»¥ç¡®ä¿å¤šä¸ªæ“ä½œåœ¨å•ä¸ªåŸå­äº‹åŠ¡ä¸­æ‰§è¡Œï¼Œä¸ä¼šè¢«å…¶ä»–Rediså‘½ä»¤ä¸­æ–­ã€‚è¿™æ„å‘³ç€ï¼Œæ— è®ºå¤šå°‘å®¢æˆ·ç«¯åŒæ—¶å‘é€å‘½ä»¤ï¼Œæ‰§è¡ŒLuaè„šæœ¬æ—¶ï¼Œè„šæœ¬å†…çš„æ‰€æœ‰å‘½ä»¤éƒ½ä¼šè¿ç»­æ‰§è¡Œï¼Œä¸­é—´ä¸ä¼šæ’å…¥å…¶ä»–å®¢æˆ·ç«¯çš„å‘½ä»¤
* è¿™ä¸ªè„šæœ¬ä¼šæ£€æŸ¥åº“å­˜æ˜¯å¦è¶³å¤Ÿï¼Œè¶³å¤Ÿçš„è¯æ‰æ‰£å‡,åŸå­æ€§


```java
-- Lua è„šæœ¬
local stockKey = KEYS[1]          -- åº“å­˜é”®
local stockCount = tonumber(ARGV[1]) -- ä¼ å…¥çš„åº“å­˜é™é¢
local stockUsedCount = redis.call('incr', stockKey) -- å¢åŠ åº“å­˜å ç”¨å¹¶è¿”å›æ–°å€¼

if stockUsedCount > stockCount then
    redis.call('decr', stockKey)  -- å¦‚æœæ–°çš„åº“å­˜è®¡æ•°è¶…è¿‡äº†é™é¢ï¼Œåˆ™å‡å›å»
    return 0                      -- è¿”å› 0 è¡¨ç¤ºæ‰£å‡å¤±è´¥
else
    return 1                      -- è¿”å› 1 è¡¨ç¤ºæ‰£å‡æˆåŠŸ
end


```


* ä½¿ç”¨ Jedis æˆ– Lettuce è¿™ç±» Redis å®¢æˆ·ç«¯åº“æ¥æ‰§è¡Œ Lua è„šæœ¬ã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•åœ¨ Java ä¸­ä½¿ç”¨ Jedis æ‰§è¡Œä¸Šè¿° Lua è„šæœ¬çš„ç¤ºä¾‹
* å°†Luaè„šæœ¬å‘é€åˆ°RedisæœåŠ¡å™¨å¹¶æ‰§è¡Œå®ƒã€‚Luaè„šæœ¬ä½œä¸ºä¸€ä¸ªæ•´ä½“è¿è¡Œï¼Œç¡®ä¿äº†æ“ä½œçš„åŸå­æ€§


```java
import redis.clients.jedis.Jedis;

public class RedisLuaExample {

    public static boolean subtractionActivityStockByRedis(Jedis jedis, String stockKey, int stockCount) {
        String luaScript = 
            "local stockKey = KEYS[1] " +
            "local stockCount = tonumber(ARGV[1]) " +
            "local stockUsedCount = redis.call('incr', stockKey) " +
            "if stockUsedCount > stockCount then " +
            "   redis.call('decr', stockKey) " +
            "   return 0 " +
            "else " +
            "   return 1 " +
            "end";

        Long result = (Long) jedis.eval(luaScript, 1, stockKey, String.valueOf(stockCount));
        return result == 1;
    }

    public static void main(String[] args) {
        try (Jedis jedis = new Jedis("localhost", 6379)) {
            String stockKey = "stock:1234";  // ç¤ºä¾‹key
            int stockCount = 10;            // å‡è®¾åº“å­˜é™åˆ¶ä¸º10
            boolean success = subtractionActivityStockByRedis(jedis, stockKey, stockCount);
            System.out.println("åº“å­˜æ‰£å‡" + (success ? "æˆåŠŸ" : "å¤±è´¥"));
        }
    }
}


```




### ä½ çš„æŠ½å¥–ç³»ç»Ÿå¦‚ä½•è§£å†³æ¶ˆæ¯é‡å‘çš„é—®é¢˜

(**ä¸Šé¢æŠ½å¥–ç³»ç»Ÿå¦‚ä½•é˜²æ­¢MQæ¶ˆæ¯é‡å¤å‘é€çš„**)


* ç³»ç»Ÿé€šè¿‡æ›´æ–°æ•°æ®åº“ä¸­çš„çŠ¶æ€å­—æ®µæ¥ç®¡ç†å’Œé˜²æ­¢æ¶ˆæ¯çš„é‡å¤å‘é€
* å­—æ®µ mq_state åœ¨æ•°æ®åº“è¡¨ user_strategy_export ä¸­ç”¨äºè·Ÿè¸ªæ¶ˆæ¯çš„å‘é€çŠ¶æ€ï¼š0ï¼šæ¶ˆæ¯æœªå‘é€ï¼Œ1ï¼šæ¶ˆæ¯å‘é€æˆåŠŸï¼Œ2ï¼šæ¶ˆæ¯å‘é€å¤±è´¥
* æ‰«æå‘è´§å• MQ çŠ¶æ€ï¼ŒæŠŠæœªå‘é€ MQ çš„å•å­æ‰«æå‡ºæ¥ï¼Œåšè¡¥å¿,è¿™é‡Œä¼šè®¾å®šè·¯ç”±ï¼Œ
* å‘é€å‰æ£€æŸ¥ï¼šåœ¨å‘é€æ¶ˆæ¯ä¹‹å‰ï¼Œç³»ç»Ÿä¼šæ£€æŸ¥ mq_state çš„å€¼ã€‚å¦‚æœçŠ¶æ€ä¸º 0ï¼ˆæœªå‘é€ï¼‰ï¼Œåˆ™ç»§ç»­å‘é€æ¶ˆæ¯ï¼›å¦‚æœçŠ¶æ€ä¸º 1ï¼ˆå·²å‘é€ï¼‰ï¼Œåˆ™è·³è¿‡å‘é€æ­¥éª¤ï¼Œé˜²æ­¢é‡å¤å‘é€ã€‚
* å‘é€åæ›´æ–°ï¼šæ¶ˆæ¯å‘é€åï¼Œæ ¹æ®å‘é€ç»“æœæ›´æ–° mq_state çš„å€¼ã€‚æˆåŠŸåˆ™è®¾ç½®ä¸º 1ï¼Œå¤±è´¥åˆ™è®¾ç½®ä¸º 2
* æ¶ˆæ¯é‡è¯•ï¼šå¯¹äºçŠ¶æ€ä¸º 2ï¼ˆå‘é€å¤±è´¥ï¼‰çš„æ¶ˆæ¯ï¼Œç³»ç»Ÿä¼šå®šæœŸæ‰«æè¿™äº›è®°å½•ï¼Œå¹¶å°è¯•é‡æ–°å‘é€ã€‚æˆåŠŸåï¼ŒçŠ¶æ€æ›´æ–°ä¸º 1ï¼›å¦‚æœå†æ¬¡å¤±è´¥ï¼Œä¿æŒçŠ¶æ€ä¸º 2ï¼Œå¹¶å¾…ä¸‹ä¸€æ¬¡æ‰«æå†æ¬¡å°è¯•







æ ¸å¿ƒï¼›MySQL äº‹åŠ¡ä¸€èµ·å†™å…¥ä¸šåŠ¡æ•°æ®å’Œä»»åŠ¡è®°å½• + MQ å‘é€ + æ›´æ–°è®°å½• + ä»»åŠ¡è¡¥å¿ + å¹‚ç­‰é‡è¯•ã€‚

æ–¹æ¡ˆï¼›å¯é æ€§ä¿è¯ï¼ŒåŸºäºåšä¸šåŠ¡æµç¨‹æ—¶ï¼Œåœ¨ä¸šåŠ¡çš„æ•°æ®è®°å½•ä¸Šä¿ç•™ä¸€ä¸ªæ¶ˆæ¯å‘é€å­—æ®µæˆ–è€…ç»Ÿä¸€ä½¿ç”¨å¦‚ job è¡¨æ¥è®°å½•ã€‚å¹¶ç¡®ä¿åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸‹å®Œæˆæ•°æ®åº“çš„æ’å…¥ã€‚MySQL äº‹åŠ¡å¤–ï¼Œå‘é€MQæ¶ˆæ¯ï¼Œå¹¶æ›´æ–°åº“è¡¨å‘é€çŠ¶æ€ã€‚å¦‚æœå‘é€å¤±è´¥ï¼Œåˆ™é€šè¿‡ä»»åŠ¡è¡¥å¿é‡æ–°å‘é€MQæ¶ˆæ¯ã€‚è¿™é‡Œè¦ç¡®ä¿ï¼ŒMQæ¶ˆæ¯ä¸­æœ‰å¹‚ç­‰å­—æ®µï¼Œç¡®ä¿æ¶ˆè´¹å¯é‡è¯•ã€‚å› ä¸ºåœ¨ä¸´ç•ŒçŠ¶æ€ï¼Œå¯èƒ½ä¼šå‘ç”ŸMQé‡å¤å‘é€ï¼Œå¦‚ç½‘ç»œæŠ–åŠ¨




