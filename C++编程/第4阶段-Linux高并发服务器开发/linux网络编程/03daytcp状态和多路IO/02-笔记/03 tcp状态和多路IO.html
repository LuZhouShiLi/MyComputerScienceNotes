<html>
<head>
  <title>03 tcp状态和多路IO</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/306387 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 12pt;
    }
  </style>
</head>
<body>
<a name="3242"/>
<h1>03 tcp状态和多路IO</h1>

<div>
<span><div>1tcp状态转换图</div><div><img src="03 tcp状态和多路IO_files/Image.png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>2 半关闭</div><div>主动方发生在FIN_WAIT_2状态,这个状态时,主动方不可以在应用层发送数据了,但是应用层还可以接收数据,这个状态称为半关闭</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-family: Monaco;color: rgb(51, 51, 51);-en-paragraph:true;"><font style="font-size: 12pt;">#include &lt;sys/socket.h&gt;</font></span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-family: Monaco;color: rgb(51, 51, 51);-en-paragraph:true;"><font style="font-size: 12pt;">int shutdown(int sockfd, int how);</font></span></div><div style="margin-top: 1em; margin-bottom: 1em;"><font style="font-size: 12pt;"><span style="font-family: Monaco;color: rgb(51, 51, 51);-en-paragraph:true;">sockfd:</span> <span style="font-family: 宋体;color: rgb(51, 51, 51);-en-paragraph:true;">需要关闭的</span><span style="font-family: Monaco;color: rgb(51, 51, 51);-en-paragraph:true;">socket</span><span style="font-family: 宋体;color: rgb(51, 51, 51);-en-paragraph:true;">的描述符</span></font></div><div style="margin-top: 1em; margin-bottom: 1em;"><font style="font-size: 12pt;"><span style="font-family: Monaco;color: rgb(51, 51, 51);-en-paragraph:true;">how:</span><span style="font-family: Monaco;color: rgb(51, 51, 51);-en-paragraph:true;">   </span> <span style="font-family: 宋体;color: rgb(51, 51, 51);-en-paragraph:true;">允许为</span><span style="font-family: Monaco;color: rgb(51, 51, 51);-en-paragraph:true;">shutdown</span><span style="font-family: 宋体;color: rgb(51, 51, 51);-en-paragraph:true;">操作选择以下几种方式</span><span style="font-family: Monaco;color: rgb(51, 51, 51);-en-paragraph:true;">:</span></font></div><div style="margin-top: 1em; margin-bottom: 1em;"><font style="font-size: 12pt;"><span style="font-family: Monaco;color: rgb(51, 51, 51);-en-paragraph:true;">   </span> <span style="font-family: Monaco;color: rgb(51, 51, 51);-en-paragraph:true;">SHUT_RD(0)</span><span style="font-family: 宋体;color: rgb(51, 51, 51);-en-paragraph:true;">：</span><span style="font-family: Monaco;color: rgb(51, 51, 51);-en-paragraph:true;">   </span> <span style="font-family: 宋体;color: rgb(51, 51, 51);-en-paragraph:true;">关闭</span><span style="font-family: Monaco;color: rgb(51, 51, 51);-en-paragraph:true;">sockfd</span><span style="font-family: 宋体;color: rgb(51, 51, 51);-en-paragraph:true;">上的读功能，此选项将不允许</span><span style="font-family: Monaco;color: rgb(51, 51, 51);-en-paragraph:true;">sockfd</span><span style="font-family: 宋体;color: rgb(51, 51, 51);-en-paragraph:true;">进行读操作。</span></font></div><div style="margin-top: 1em; margin-bottom: 1em;"><font style="font-size: 12pt;"><span style="font-family: Monaco;color: rgb(51, 51, 51);-en-paragraph:true;">                  </span> <span style="font-family: 宋体;color: rgb(51, 51, 51);-en-paragraph:true;">该套接字</span><span style="font-family: 宋体;font-weight: bold;color: rgb(51, 51, 51);-en-paragraph:true;">不再接收数据</span><span style="font-family: 宋体;color: rgb(51, 51, 51);-en-paragraph:true;">，任何当前在套接字接受缓冲区的数据将被无声的丢弃掉。</span></font></div><div style="margin-top: 1em; margin-bottom: 1em;"><font style="font-size: 12pt;"><span style="font-family: Monaco;color: rgb(51, 51, 51);-en-paragraph:true;">   </span> <span style="font-family: Monaco;color: rgb(51, 51, 51);-en-paragraph:true;">SHUT_WR(1):</span><span style="font-family: Monaco;color: rgb(51, 51, 51);-en-paragraph:true;">    </span> <span style="font-family: 宋体;color: rgb(51, 51, 51);-en-paragraph:true;">关闭</span><span style="font-family: Monaco;color: rgb(51, 51, 51);-en-paragraph:true;">sockfd</span><span style="font-family: 宋体;color: rgb(51, 51, 51);-en-paragraph:true;">的写功能，此选项将不允许</span><span style="font-family: Monaco;color: rgb(51, 51, 51);-en-paragraph:true;">sockfd</span><span style="font-family: 宋体;color: rgb(51, 51, 51);-en-paragraph:true;">进行写操作。进程不能在对此套接字发出写操作。</span></font></div><div><font style="font-size: 12pt;"><span style="font-family: Monaco;color: rgb(51, 51, 51);-en-paragraph:true;">   </span> <span style="font-family: Monaco;color: rgb(51, 51, 51);-en-paragraph:true;">SHUT_RDWR(2):</span><span style="font-family: Monaco;color: rgb(51, 51, 51);-en-paragraph:true;">  </span> <span style="font-family: 宋体;color: rgb(51, 51, 51);-en-paragraph:true;">关闭</span><span style="font-family: Monaco;color: rgb(51, 51, 51);-en-paragraph:true;">sockfd</span><span style="font-family: 宋体;color: rgb(51, 51, 51);-en-paragraph:true;">的读写功能。相当于调用</span><span style="font-family: Monaco;color: rgb(51, 51, 51);-en-paragraph:true;">shutdown</span><span style="font-family: 宋体;color: rgb(51, 51, 51);-en-paragraph:true;">两次：首先是以</span><span style="font-family: Monaco;color: rgb(51, 51, 51);-en-paragraph:true;">SHUT_RD,</span><span style="font-family: 宋体;color: rgb(51, 51, 51);-en-paragraph:true;">然后以</span><span style="font-family: Monaco;color: rgb(51, 51, 51);-en-paragraph:true;">SHUT_WR</span><span style="font-family: 宋体;color: rgb(51, 51, 51);-en-paragraph:true;">。</span></font></div></div><div><br/></div><div><br/></div><div>3 心跳包</div><div>如果对方异常断开,本机检测不到,一直等待,浪费资源</div><div>需要设置tcp的保持连接,作用就是每隔一定的时间间隔发送探测分节,如果连续发送多个探测分节对方还未回,就将次连接断开</div><div style="margin-top: 1em; margin-bottom: 1em;">int  keepAlive = 1;</div><div style="margin-top: 1em; margin-bottom: 1em;">setsockopt(listenfd, SOL_SOCKET, SO_KEEPALIVE, (void*)&amp;keepAlive, sizeof(keepAlive));</div><div><br/></div><div>心跳包:  最小粒度</div><div>乒乓包:  携带比较多的数据的心跳包</div><div><br/></div><div>4 设置端口复用</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-family: Monaco;font-size: 9pt;color: rgb(51, 51, 51);-en-paragraph:true;">int opt = 1;</span></div><div><span style="mso-tab-count: 1;font-family: Monaco;font-size: 9pt;color: rgb(51, 51, 51);-en-paragraph:true;">   </span> <span style="font-family: Monaco;font-size: 9pt;color: rgb(51, 51, 51);-en-paragraph:true;">setsockopt(listenfd, SOL_SOCKET, SO_REUSEADDR, &amp;opt, sizeof(opt));</span></div></div><div>注意: 程序中设置某个端口重新使用,在这之前的其他网络程序将不能使用这个端口</div><div><br/></div><div><br/></div><div>5 高并发服务器</div><div>阻塞等待  消耗资源</div><div>非阻塞忙轮询 消耗cpu</div><div>多路IO</div><div>多路IO转接(多路IO复用): 内核监听多个文件描述符的属性(读写缓冲区)变化</div><div>如果某个文件描述符的读缓冲区变化了,这个时候就是可以读了,将这个事件告知应用层</div><div><img src="03 tcp状态和多路IO_files/Image [1].png" type="image/png" data-filename="Image.png"/></div><div>6  select epoll  poll</div><div>windwos   使用select   select跨平台</div><div>poll 少用</div><div>epoll   linux </div><div><br/></div><div>7  select函数的API</div><div>#include &lt;sys/select.h&gt;</div><div> /* According to earlier standards */</div><div>       #include &lt;sys/time.h&gt;</div><div>       #include &lt;sys/types.h&gt;</div><div>       #include &lt;unistd.h&gt;</div><div><br/></div><div>       int select(int nfds, fd_set *readfds, fd_set *writefds,</div><div>                  fd_set *exceptfds, struct timeval *timeout);</div><div>功能: 监听多个文件描述符的属性变化(读,写,异常)</div><div>       void FD_CLR(int fd, fd_set *set);</div><div>       int  FD_ISSET(int fd, fd_set *set);</div><div>       void FD_SET(int fd, fd_set *set);</div><div>       void FD_ZERO(fd_set *set);</div><div><br/></div><div>参数:</div><div>    nfds  : 最大文件描述符+1</div><div>    readfds : 需要监听的读的文件描述符存放集合</div><div>    writefds :需要监听的写的文件描述符存放集合   NULL</div><div>    exceptfds : 需要监听的异常的文件描述符存放集合  NULL</div><div>    timeout: 多长时间监听一次   固定的时间,限时等待   NULL 永久监听</div><div>    struct timeval {</div><div>               long    tv_sec;         /* seconds */ 秒</div><div>               long    tv_usec;        /* microseconds */微妙</div><div>           };</div><div><div><br/></div>
  返回值: 返回的是变化的文件描述符的个数</div><div>注意: 变化的文件描述符会存在监听的集合中,未变化的文件描述符会从集合中删除</div><div>    </div><div> 8 select实现的原理</div><div><img src="03 tcp状态和多路IO_files/Image [2].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>9 select 的优缺点</div><div>优点: 跨平台</div><div>缺点:</div><div>文件描述符1024的限制   由于 <span style="font-size: 10.5pt; mso-bidi-font-size: 11.0pt; font-family: &quot;Calibri&quot;,sans-serif; mso-fareast-font-family: 宋体; mso-bidi-font-family: &quot;Times New Roman&quot;; mso-font-kerning: 1.0pt; mso-ansi-language: EN-US; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">FD_SETSIZE的限制</span></div><div><font face="Calibri, sans-serif"><span style="font-size: 14px;">只是返回变化的文件描述符的个数,具体哪个那个变化需要遍历</span></font></div><div><font face="Calibri, sans-serif"><span style="font-size: 14px;">每次都需要将需要监听的文件描述集合由应用层符拷贝到内核</span></font></div><div><font face="Calibri, sans-serif"><span style="font-size: 14px;">大量并发,少了活跃,select效率低</span></font></div><div><font face="Calibri, sans-serif"><span style="font-size: 14px;"><br/></span></font></div><div><font style="font-family: Calibri, sans-serif;"><span style="font-size: 14px;">假设现在 4-1023个文件描述符需要监听,但是5-1000这些文件描述符关闭了?</span></font></div><div><font style="font-family: Calibri, sans-serif;"><span style="font-size: 14px;">假设现在 4-1023个文件描述符需要监听,但是只有 5,1002 发来消息- 无解</span></font></div><div><span style="font-size: 10.5pt; mso-bidi-font-size: 11.0pt; font-family: &quot;Calibri&quot;,sans-serif; mso-fareast-font-family: 宋体; mso-bidi-font-family: &quot;Times New Roman&quot;; mso-font-kerning: 1.0pt; mso-ansi-language: EN-US; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;"><br/></span></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></span>
</div></body></html> 